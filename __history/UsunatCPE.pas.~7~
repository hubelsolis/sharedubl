unit UsunatCPE;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics,
  Controls, Forms, Dialogs, xmldom, XMLIntf, StdCtrls,
  Buttons, XMLDoc, AbBase, AbBrowse, AbZBrows, AbZipper,
  InvokeRegistry, IdBaseComponent, IdCoder, IdCoder3to4, IdCoderMIME,
  Rio, SOAPHTTPClient,Clipbrd, msxmldom, System.Net.URLClient;

const
  CEROS_PRECIOS = 4;
  CEROS_XML = 2;
  CEROS_XML_CANTIDAD = 4;
  codificadoXML = 'ISO-8859-1';  //'ISO-8859-1'  'utf-8'

type
  res_summary = record
      dual  : LongInt;
      dual2 : LongInt;
      archivo : string;
      total : Double;
  end;

  TFrmGenCPE = class(TForm)
    hoja: TMemo;
    BtnLevantarDetallesVenta: TBitBtn;
    xmldoc: TXMLDocument;
    AbZipper1: TAbZipper;
    ClienteSOAP: THTTPRIO;
    IdEncoderMIME1: TIdEncoderMIME;
    BitBtn1: TBitBtn;
    mmoconfig: TMemo;
    chksinenvio: TCheckBox;
    mmoXML: TMemo;
    btnLevantarGuiaRem: TBitBtn;
    Label1: TLabel;
    procedure BtnLevantarDetallesVentaClick(Sender: TObject);
    procedure ClienteSOAPBeforeExecute(const MethodName: string;
      SOAPRequest: TStream);
    procedure FormCreate(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
    procedure btnLevantarGuiaRemClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    SEND_ERROR : string;
    SEND_RESPOSE : string;
    res_numero : Integer;

    //res_dual : array[1..12] of LongInt;
    res_archivo : array[1..12] of res_summary;

    SUMRESUMEN : Double;

    X_NRO_RESUMEN : SmallInt;

    function comprime(patharchivo,archivo,pathdestino,destino : string):SmallInt;
    function firmar(pathdata,archivodata,pathFirmado,archivofirmado,tcertificado,passcertificado:WideString):Boolean;
    function GeneraCPE(dual,fecharesumen : string; concdata : Boolean):string;
    function GeneraInvoice(dual : string; archivo : string; concdata : Boolean):Integer;
    function GeneraCreditNote(dual : string; archivo : string; concdata : Boolean):Integer;
    function GeneraDebitNote(dual : string; archivo : string; concdata : Boolean):Integer;
    function ComunicacionBaja(dual : string; archivo : string; concdata : Boolean):Integer;
    function GeneraDespachtAdvice(dual : string; archivo : string; concdata : Boolean):Integer;
    function GeneraSummaryDocs(dual : string; archivo : string; concdata : Boolean; limiteI,LimiteS,indice : integer):Integer;
    function CPEenvioBETA(pathenvio,archivo,ticket:string):Boolean;

  end;

var
  FrmGenCPE: TFrmGenCPE;

implementation
Uses UBLInvoice21,UBLCreditNote21,UBLDebitNote21,UBLDespatchAdvice21,
     //ACBrDFeSSL,ACBrUtil,
     Operadores,types,Math,USQLUtils,UDBModulo, Ureport,USunatVariables,
  Uconfiguracion;

{$R *.dfm}


{$DEFINE NO_USAR_NETFRAMEWORK}



{$IFDEF USAR_NETFRAMEWORK}
  function zfirmaxml(xmlsinfirmar,xmlfirmado,pathcertificado,clavecertificado:WideString):Integer; stdcall; external 'firmaxml509.dll';
{$ELSE NO_USAR_NETFRAMEWORK }
  function ACBrfirmaXML(xmlsinfirmar,xmlfirmado,pathcertificado,clavecertificado:WideString; conformato : integer):Integer;
  var xmltmp  : TXMLDocument;
      XMLAnsi : AnsiString;
      //ssl     : TDFeSSL;
   begin
      if (not FileExists(xmlsinfirmar) ) or (not FileExists(pathcertificado) ) then
        begin
          Result:=0;
          exit;
        end;
      xmltmp:= TXMLDocument.Create(FrmGenCPE);
      xmltmp.Active:=True;
      xmltmp.Encoding :='ISO-8859-1';
      xmltmp.StandAlone:='no';
      xmltmp.XML.LoadFromFile(xmlsinfirmar);
      //ssl:=TDFeSSL.create;
      //ssl.SSLCryptLib := cryWinCrypt;       //(cryNone, cryOpenSSL, cryCapicom, cryWinCrypt);
      //ssl.SSLXMlsignLib:=xsLibXml2;         //(xsNone , xsXmlSec  , xsMsXml   , xsMsXmlCapicom, xsLibXml2);
      //ssl.ArquivoPFX:=pathcertificado;
      //ssl.Senha:=clavecertificado;
      //ssl.CarregarCertificado;
      //XMLAnsi:=ACBrUTF8ToAnsi(xmltmp.XML.Text);

      //(XMLUTF8,'docelement','infelement','signode','namespace','idsignature','idatributo');
      //if (conformato=1) then
        //xmltmp.XML.Text:=FormatXMLData(ssl.Assinar( XMLAnsi ,'ExtensionContent','','','ext','',''))
      //else
        //xmltmp.XML.Text:=ssl.Assinar( XMLAnsi  ,'ExtensionContent','','','ext','','');

      xmltmp.XML.SaveToFile(xmlfirmado);
      xmltmp.Active:=False;
      //ssl.Free;
      xmltmp.Free;
      Result:=1;
   end;
{$ENDIF USAR_NETFRAMEWORK}



function get_variable_sfs(nombre:string):string;
var i,j : Integer;
 begin
   j:=-1;
   if FrmGenCPE.mmoconfig.Lines.Count<2 then
     FrmGenCPE.mmoconfig.Lines.LoadFromFile(completardir(WorkDir,'Facturador.ini'));

   for i:=0 to FrmGenCPE.mmoconfig.Lines.Count-1 do
    begin
      if nombre=SplitCadena(FrmGenCPE.mmoconfig.Lines[i],'=',1) then
        j:=i;
    end;
   if j>-1 then
    Result:=SplitCadena(FrmGenCPE.mmoconfig.Lines[j],'=',2)
   else
    Result:='';
 end;

procedure TFrmGenCPE.BitBtn1Click(Sender: TObject);
begin
  {ACBrfirmaXML('D:\firma\20604749779-01-FE10-00000002.xml',
               //'D:\firma\20605083359-01-FE08-00000001.xml',
               'D:\firma\Firmado_20604749779-01-FE10-00000002.xml',
               'D:\firma\CASADELCONSTRUCTOREIRL.pfx',
               'Casa@233674',1);}
end;

procedure TFrmGenCPE.BtnLevantarDetallesVentaClick(Sender: TObject);
var TipoAfectacion,registro,tmpDESCT : string;
     UNIDAD : string;
     pe : string;
     rcp : string;
begin
 UNIDAD:='Unidad';
 if get_variable_sfs('UNIDAD_DEFECTO')<>'' then
  UNIDAD:='"'+get_variable_sfs('UNIDAD_DEFECTO')+'" as Unidad';

 IF IDDUAL='' then
   begin
     ShowMessage('NO SE PUDO DETERMINAR EL ID DE VENTAS .... Reinicie el Facturador... ');
     Exit;
   end;

 if True then //chkXML.Checked
   begin

     IF DECLARAR_DSCTOS='SI' then
      tmpDESCT:=''
     ELSE
      tmpDESCT:='_SD';

     if FrmGenCPE.chksinenvio.Checked then  pe:='and enviosunat=0'
     else pe:='';

     rcp:='';
     if Copy(DM1.ZRegVen.Fields[3].Asstring,1,1)='7' then rcp:='and rcptipo=3';

      //SELECT from registro r where r.dDual=2964 and ulink like '20%'
        DM1.ZDetVen.Close;
        DM1.ZDetVen.SQL.Clear;


        if ValI(DM1.ZRegVen.FieldByName('TIPOCOMPROBANTE').AsString)<=10 then
                                       //       0            1         2             3          4       5         6        7        8
          DM1.ZDetVen.SQL.Add(FormatSQL3('SELECT a.ITEM, a.CANTIDAD, '+Unidad+', a.DESCRIPCION, a.PU, a.PU_OR, a.VVUNIT,  a.DSCTO, a.CARGO, '+
          //   9       10     11          12                13          14         15          16           17              18          19
          'a.VVITEM, a.ISC, a.IGV, a.TIPOOPERACION, a.TIPOAFECTACION, a.MONTO, a.SUBTOTAL, a.PRODUCTO, a.CodigoSUNAT, a.TIPODSCTO, a.DSCTOUNIT,'+
          // 20          21          22         23
          ' a.BOLSAS, a.TASAICBPER, a.ICBPER, a.PESO '+
          'FROM LINEACOMPROBANTE'+tmpDESCT+' a '+
          'WHERE a.item>0 and a.'+IDDUAL+'='+StrI(ValI(DM1.ZRegVen.Fields[0].Asstring))+' and ulink like "'+CUENTA_ALMACENES+'%"'))
        else
                                      //               0            1            2           3            4           5           6              7               8
          DM1.ZDetVen.SQL.Add(FormatSQL3('select a.'+IDDUAL+',a.FECHAEMISION,a.HORA,a.TIPOCOMPROBANTE,a.SERIECO,a.NUMEROCO,a.TIPODOCUMENTO,a.NRODOCUMENTO,a.RAZONNOMBRE, '+
                                        //  9                   10                              11                             12
                                        'a.MONEDA,abs(a.BASEIMPONIBLE) AS BASEIMPONIBLE,abs(a.INAFECTAS) AS INAFECTAS,abs(a.TOTALEXONERADA) AS TOTALEXONERADA,'+
                                        //              13                    14                       15                      16
                                        'abs(a.GRATUITAS) AS GRATUITAS,abs(a.IGVIPM) AS IGVIPM,abs(a.ISC) AS ISC,abs(a.OTROSTRIBUTOS) AS OTROSTRIBUTOS,'+
                                        //            17                          18                             19                        20            21
                                        'abs(a.DESCUENTOS) AS DESCUENTOS,abs(a.CARGOS) AS CARGOS, abs(a.IMPORTETOTAL) AS IMPORTETOTAL,a.GUIAREMISION,a.TIPOGUIA,'+
                                        //   22                 23                   24         25          26          27          28           29             30
                                        ' a.PLACA,abs(a.PERCEPCION) AS PERCEPCION,a.RCPTIPO,a.RCPSERIE,a.RCPNUMERO,a.CODIGONOTA,a.MOTIVONOTA,a.TIPOPAGO,a.FECHAVENCIMIENTO, '+
                                        //   31             32         33               34       35             36
                                        'a.TIPODSCTO, a.DSCTOUNIT, a.IGVTASA,0 as venviosunat, a.DSCTOGLOBAL, a.CARGOGLOBAL '+
                                        'FROM REGISTROVENTAS a '+
                                        'where (a.situacion in (2,3)) and (a.TIPOCOMPROBANTE in ('+Copy(DM1.ZRegVen.Fields[3].Asstring,1,1)+')) '+rcp+' and a.comprobanteelectronico=1 '+pe+' '+   // and enviosunat=0
                                        'and fechaemision="'+FormatDateTime(FormatoFecha,ValidaFecha(DM1.ZRegVen.Fields[1].Asstring))+'" '+
                                        'order by a.fechaemision,a.'+IDDUAL+',a.serieco,a.numeroco;'));
                                        //25/10/2019 order by por el dual

      //reportes.hoja.Lines.Add(DM1.ZDetVen.SQL[0]);
      DM1.ZDetVen.Open;
   end
 else
   BEGIN
      if True then //ValR(sfsIGV_SUNAT)=0 then // sin IGV
        begin
          TipoAfectacion:='20'
        end
      Else
        begin
          TipoAfectacion:='10';
        end;

      if DM1.ZDetVen.fields[26].AsString='1' then
       registro:='registro'
      else
       registro:='tmpregistro';

      //if ValI(Zregistroventa.fields[18].AsString) in [7,8] then
       BEGIN
        DM1.ZDetVen.Close;
        DM1.ZDetVen.SQL.Clear;             //    0          1        2          3            4     5       6
        DM1.ZDetVen.SQL.Add(FormatSQL3('SELECT '+unidad+',CANTIDAD,PRODUCTO,"" as CODSUNAT,DETALLE,PU,0 as Dsctos, IGV, '+
                                         'case PU '+
                                         ' when 0 then '+TipoAfectacion+'+1 '+
                                         ' else '+TipoAfectacion+' '+
                                         'end as TipoAfectacion, '+
                                         '0 as ISC,01 as TipISC,PU '+
                                         'FROM '+registro+' '+
                                         'WHERE (PU IS NOT NULL or PU>0)AND '+IDDUAL+'='+StrI(ValI(DM1.ZRegVen.Fields[17].Asstring))));
        end;

       // Clipboard.AsText:=Zdetalleventa.SQL[0];
         //
         // ShowMessage(Zdetalleventa.SQL[0]);

      DM1.ZDetVen.Open;
 
      if DM1.ZDetVen.RecordCount=0 then
       begin
         MessageDlg('El Comprobante '+DM1.ZRegVen.fields[19].AsString+'-'+CompletarCadena(DM1.ZRegVen.fields[20].AsString,'0',DIGITOS_NUMCOMPROBANTE)+' no tiene detalles, revise ', mtError,[mbOk], 0);
         Exit;
       end;
      { tipoAfectacion
        10 Gravado - Operacion Onerosa   (*)
        11 Gravado – Retiro por premio   (*)
        12 Gravado – Retiro por donacion
        13 Gravado – Retiro
        14 Gravado – Retiro por publicidad
        15 Gravado – Bonificaciones
        16 Gravado – Retiro por entrega a trabajadores  (*)
        17 Gravado – IVAP
        20 Exonerado - Operacion Onerosa   (*)
        21 Exonerado – Transferencia Gratuita (*)
        30 Inafecto - Operacion Onerosa
        31 Inafecto – Retiro por Bonificacion
        32 Inafecto – Retiro
        33 Inafecto – Retiro por Muestras Medicas
        34 Inafecto - Retiro por Convenio Colectivo
        35 Inafecto – Retiro por premio
        36 Inafecto - Retiro por publicidad
        40 Exportacion
      TipoComprobante.Text:=CompletarCadena(Zregistroventa.fields[18].AsString,'0',2);
      SerieComprobante.Text:=Zregistroventa.fields[19].AsString;
      NumeroComprobante.Text:=CompletarCadena(Zregistroventa.fields[20].AsString,'0',DIGITOS_NUMCOMPROBANTE);
      }
   end;
end;



procedure TFrmGenCPE.ClienteSOAPBeforeExecute(const MethodName: string;
  SOAPRequest: TStream);
var
  sl : TStringList;
  i : Integer;
begin
  SOAPRequest.Position := 0;
  //USUARIO SECUNDARIO REGISTRADO EN SOL

  sl := TStringList.Create;
  try
    sl.LoadFromStream(SOAPRequest);

    // agrego el spacename
    sl.Text := StringReplace(sl.Text, 'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',
    'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"', [rfReplaceAll]);

    //agrego el header
    sl.Text := StringReplace(sl.Text, '<SOAP-ENV:Body>',
    //'<SOAP-ENV:Header><wsse:Security></wsse:Security></SOAP-ENV:Header><SOAP-ENV:Body>', [rfReplaceAll]);
    '<SOAP-ENV:Header><wsse:Security><wsse:UsernameToken><wsse:Username>'+RUC_EMPRESA+SV_USUARIO_SOL+'</wsse:Username><wsse:Password>'+SV_CLAVE_SOL+'</wsse:Password></wsse:UsernameToken></wsse:Security></SOAP-ENV:Header><SOAP-ENV:Body>', [rfReplaceAll]);

    SOAPRequest.Size := 0;
    SOAPRequest.Position := 0;
    sl.SaveToStream(SOAPRequest);
    hoja.Text:=sl.Text;
  finally
    sl.Free;
  end;
end;


function TFrmGenCPE.comprime(patharchivo,archivo,pathdestino,destino:string):SmallInt;
 begin
  // recuerda que la extension tiene que ser ZIP, caso contrario sale unhandled
  Result:=0;

  if FileExists(pathdestino+destino) then
     DeleteFile(pathdestino+destino);

  if Not DirectoryExists(pathdestino) then
    ForceDirectories(pathdestino);

  if FileExists(patharchivo+archivo) then
     begin
        AbZipper1.BaseDirectory := '';
        AbZipper1.FileName := pathdestino+destino;
        AbZipper1.AddFiles(patharchivo+archivo,0);
        AbZipper1.CloseArchive;
        AbZipper1.Save;
        Result:=1;
     end
  else
     begin
       Result := 0;
     end;
 end;

 
function TFrmGenCPE.firmar(pathdata,archivodata,pathFirmado,archivofirmado,tcertificado,passcertificado:WideString):Boolean;
var error : boolean;
    scertificado : string;
begin
  if Not DirectoryExists(pathFIRMADO) then
    ForceDirectories(pathFIRMADO);

  error:=False;
  if not FileExists(completardir(pathdata,archivodata)) then
    begin
      ShowMessage(' No se encuentra el archivo  '+completardir(pathdata,archivodata));
      error:=true;
    end;

  scertificado := WorkDir+'\CPE\CERT\'+tcertificado;
  if not FileExists(scertificado) then
    begin
      ShowMessage(' No se encuentra el Certificado '+scertificado);
      error:=True;
    end;

  if not error then
   begin
     try
        {$IFDEF USAR_NETFRAMEWORK}
          ZFirmaXML(completardir(pathDATA,archivodata),
                    completardir(pathFIRMADO,archivofirmado),
                    scertificado,
                    passcertificado);
        {$ELSE NO USAR_NETFRAMEWORK }
          ACBrfirmaXML(completardir(pathDATA,archivodata),
                    completardir(pathFIRMADO,archivofirmado),
                    scertificado,
                    passcertificado,
                    0 );
        {$ENDIF USAR_NETFRAMEWORK}
     except
       error:=True;
     end;
   end;

  Result:=NOT error;
end;

procedure TFrmGenCPE.FormCreate(Sender: TObject);
begin
  X_NRO_RESUMEN:=0;
end;

function TFrmGenCPE.GeneraCPE(dual,fecharesumen : string; concdata : Boolean):string;
var patharchivo,archivo,TMP : string;
    res_comprobantes,res_limite,res_cantidadbase,res_ultcantidad,i,NRO_RESUMEN_INICIAL : Integer;
    limI,limS : array[1..9] of integer;
 begin
   Result:='';
   if (RUC_EMPRESA='') or (RAZON_EMPRESA='') or (CODIGO_POSTAL='') or (DIRECCION_EMPRESA='') or (URBANIZACION_ZONA='') or (DEPARTAMENTO='')
     or (PROVINCIA='') or (DISTRITO='') then
   begin
    if (RUC_EMPRESA='')       then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE RUC_EMPRESA=>'+RUC_EMPRESA+'<');
    if (RAZON_EMPRESA='')     then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE RAZON_EMPRESA=>'+RAZON_EMPRESA+'<');
    IF (CODIGO_POSTAL='')     then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE CODIGO_POSTAL=>'+CODIGO_POSTAL+'<');
    IF (DIRECCION_EMPRESA='') then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE DIRECCION_EMPRESA=>'+DIRECCION_EMPRESA+'<');
    IF (URBANIZACION_ZONA='') then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE URBANIZACION_ZONA=>'+URBANIZACION_ZONA+'<');
    IF (DEPARTAMENTO='')      then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE DEPARTAMENTO=>'+DEPARTAMENTO+'<');
    IF (PROVINCIA='')         then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE PROVINCIA=>'+PROVINCIA+'<');
    IF (DISTRITO='')          then showmessage('ERROR EN CONFIGURACION DE EMPRESA, VERIFIQUE DISTRITO=>'+DISTRITO+'<');
    Exit;
   end;

  if Not DM1.ZRegVen.Active then
    begin
      ShowMessage('Se requiere el registro de ventas...');
      Exit;
    end;

  SUMRESUMEN:=0;

  // para Comprobante a Comprobante FE y sus Notas
  if ValI(dual)>0 then
   BEGIN
    ActivaDM1UtilSQL('Select r.FECHAEMISION,r.TIPOCOMPROBANTE,r.SERIECO,r.NUMEROCO '+
    'from REGISTROVENTAS r '+
    'where r.DUAL='+dual,false);
    if (DM1.UtilSQL.RecordCount>0) then
      begin
        //\CPE\2018\03\DATA\;
        //01/02/2018
        //1234567890
        patharchivo:=WorkDir+'\CPE\';
        //+Copy(DM1.UtilSQL.Fields[0].AsString,7,4)+'\'+Copy(DM1.UtilSQL.Fields[0].AsString,4,2)+'\DATA\';
        if Not DirectoryExists(patharchivo) then
          ForceDirectories(patharchivo);

        //Facturas y sus Notas asociadas ...
        //20542401711-01-FE01-00000002.xml
        archivo:=
        RUC_EMPRESA+'-'+
        CompletarCadena( DM1.UtilSQL.Fields[1].AsString ,'0',2)+'-'+
        'CPE2'+'-'+ //DM1.UtilSQL.Fields[2].AsString
        CompletarCadena( '0' , '0',8)+'.xml';  //DM1.UtilSQL.Fields[3].AsString

        //ShowMessage(patharchivo+archivo);
        case ValI(DM1.UtilSQL.Fields[1].AsString) of
          1,3 : GeneraInvoice(dual,patharchivo+archivo,concdata );
          7 : GeneraCreditNote(dual,patharchivo+archivo,concdata );
          8 : GeneraDebitNote(dual,patharchivo+archivo,concdata );
          10  : GeneraDespachtAdvice(dual,patharchivo+archivo,concdata);
        end;
        Result:=patharchivo+'|'+archivo;
      end;
    DM1.UtilSQL.Close;
   END;

  // para resumenes y sus notas
  if fecharesumen<>'' then
   begin
      //showmessage(fecharesumen);

      patharchivo:=WorkDir+'\CPE\'+Copy(fecharesumen,1,4)+'\'+Copy(fecharesumen,5,2)+'\DATA\';

      if Not DirectoryExists(patharchivo) then
        ForceDirectories(patharchivo);

      //numeracion del resumen
      //123456789012345
      //RC-20191005-001
      ActivaDM1ConsultaSQL('SELECT REFERENCEID FROM CDR '+
      'WHERE FECHAEMISION="'+FormatDateTime(FormatoFecha,ValidaFecha(DM1.ZRegVen.fields[1].AsString))+
      '" AND REFERENCEID LIKE "R%" ORDER BY REFERENCEID DESC',FALSE);

      //25/10/2019 NUMERO_DE_RESUMEN
      if DM1.ConsultaSQL.RecordCount>0 then
        NRO_RESUMEN_INICIAL:=X_NRO_RESUMEN+ValI(Copy(DM1.ConsultaSQL.Fields[0].AsString,13,3))  // NRO INICIAL, CUENTA CUANTOS DUALES SON
      else
        NRO_RESUMEN_INICIAL:=X_NRO_RESUMEN+0;

      //04/11/2019
      if Length(StrI(NRO_RESUMEN_INICIAL))>2 then NRO_RESUMEN_INICIAL:=ValI( Copy(StrI(NRO_RESUMEN_INICIAL),2,2) );

      //ShowMessage(STRI(NRO_RESUMEN_INICIAL));

      TMP:='';
      if FrmGenCPE.chksinenvio.checked then
        TMP:='and r.ENVIOSUNAT=0';

      //cantidad de comprobantes a enviarse
      ActivaDM1ConsultaSQL('select count(dual) from registroventas r '+
      'where (r.situacion in (2,3)) and r.COMPROBANTEELECTRONICO=1 and '+
      'r.fechaemision="'+FormatDateTime(FormatoFecha,ValidaFecha(DM1.ZRegVen.fields[1].AsString))+
      '" and r.TIPOCOMPROBANTE='+copy(DM1.ZRegVen.fields[3].AsString,1,1)+' '+TMP,false);
      res_comprobantes:=ValI(DM1.ConsultaSQL.Fields[0].AsString);
      res_limite:=500; // cantidad limite  segun el manual de SUNAT

      //Clipboard.AsText := DM1.ConsultaSQL.SQL[0];
      //showmessage('A enviarse '+stri(res_comprobantes));

      res_cantidadbase:=Trunc(res_comprobantes/res_limite);
      res_ultcantidad:=res_comprobantes-res_cantidadbase*res_limite;
      res_numero:=res_cantidadbase;
      if res_ultcantidad<>0 then Inc(res_numero);

      if res_numero=1 then
        begin
          limI[1]:=1;
          limS[1]:=res_ultcantidad;
        end
      else
        begin
          for i := 1 to res_numero do
           begin
            limI[i]:=res_limite*(i-1)+1;
            limS[i]:=res_limite*i;
           end;
          if res_ultcantidad<>0 then
           limS[res_numero]:=limI[res_numero]+res_ultcantidad-1;
        end;


      //1234567890123
      //10/02/2018-30
      //
      for i := 1 to res_numero do
       begin
          archivo:=
          RUC_EMPRESA+'-'+
//          'RC'+'-'+copy(fecharesumen,1,8)+'-'+completarCadena(StrI(NRO_RESUMEN_INICIAL+i),'0',3)+'.xml';
          'RC'+'-'+copy(fecharesumen,1,8)+'-'+CODIGO_LOCAL_ANEXO+
          completarCadena(StrI(NRO_RESUMEN_INICIAL+i),'0',2)+'.xml';
          //codigo de local ANEXO 02/10/2019

          GeneraSummaryDocs(dual,patharchivo+archivo,concdata,limI[i],limS[i],i);

          res_archivo[i].archivo:=archivo;
          res_archivo[i].total:=SUMRESUMEN;
       end;

      Result:=patharchivo+'|'+archivo;
   end;

 end;

function EliminaProhibidos(S:String):string;
var t : string;
 begin
   t:=Trim(s);
   {if (BuscaSTR2(s,'&')>-1) and (false) then
    begin
       //ShowMessage('EP1>>'+s);
       //ShowMessage('EP2>>'+Copy(s,BuscaSTR2(s,'&'),5));
       if Copy(s,BuscaSTR2(s,'&'),5)<>'&amp;'  then
       t:=Trim(StrCom(s,'&','&amp;'));   // varios caracteres prohibidos
       //ShowMessage('EP3>>'+t);
    end;
   t:=Trim(StrCom(t,'%','&percnt;'));        // varios caracteres prohibidos
   t:=Trim(StrCom(t,'>','&gt;'));    // varios caracteres prohibidos
   t:=Trim(StrCom(t,'<','&lt;'));    // varios caracteres prohibidos
   t:=Trim(StrCom(t,'"','&quot;'));    // varios caracteres prohibidos
   t:=Trim(StrCom(t,chr(39),'&apos;'));    // varios caracteres prohibidos  }
   {$IFDEF USAR_NETFRAMEWORK}
       t:=t;
   {$ELSE NO_USAR_NETFRAMEWORK }
       t:=Trim(StrCom(t,'´´','"'));
       t:=Trim(StrCom(t,'``','"'));

       t:=Trim(StrCom(t,'´',Chr(39)));
       t:=Trim(StrCom(t,'`',Chr(39)));

       t:=Trim(StrCom(t,'“','"'));
       t:=Trim(StrCom(t,'”','"'));
   {$ENDIF USAR_NETFRAMEWORK}
   result:=t;
 end;

// 2023 sincronize
function TFrmGenCPE.GeneraInvoice(dual : string; archivo : string; concdata : Boolean):Integer;
var cpe : IXMLInvoiceType;
    i,j,k,l : Integer;
    MONEDA, importe1001_BIM, importe1002_INA, importe1003_EXO, importe1004_GRA,
    TOTAL_IGV, TOTAL_IMPUESTOS, TOTAL_DESCUENTOS, TOTAL_CARGOS, IMPORTE_TOTAL,
    TOTAL_BRUTO,TIPO_DOC_CLIENTE, NRO_DOC_CLIENTE,RAZON_NOMBRE_CLIENTE : string;
    DSCTO_GLOBAL, CARGO_GLOBAL,OTROS_TRIBUTOS : string;

    NodoRazonEmpresa1  : IXMLNode;
    NodoRazonEmpresa2  : IXMLNode;
    NodoRazonEmpresa3  : IXMLNode;
    NodoNombreCliente : IXMLNode;

 begin
  {
  //               0            1            2           3            4           5           6              7               8
  'select a.'+IDDUAL+',a.FECHAEMISION,a.HORA,a.TIPOCOMPROBANTE,a.SERIECO,a.NUMEROCO,a.TIPODOCUMENTO,a.NRODOCUMENTO,a.RAZONNOMBRE, '+
  //  9                   10                              11                             12
  'a.MONEDA,abs(a.BASEIMPONIBLE) AS BASEIMPONIBLE,abs(a.INAFECTAS) AS INAFECTAS,abs(a.TOTALEXONERADA) AS TOTALEXONERADA,'+
  //              13                    14                       15                      16
  'abs(a.GRATUITAS) AS GRATUITAS,abs(a.IGVIPM) AS IGVIPM,abs(a.ISC) AS ISC,abs(a.OTROSTRIBUTOS) AS OTROSTRIBUTOS,'+
  //            17                          18                             19                        20            21
  'abs(a.DESCUENTOS) AS DESCUENTOS,abs(a.CARGOS) AS CARGOS, abs(a.IMPORTETOTAL) AS IMPORTETOTAL,a.GUIAREMISION,a.TIPOGUIA,'+
  //   22                 23                   24         25          26          27          28           29             30
  ' a.PLACA,abs(a.PERCEPCION) AS PERCEPCION,a.RCPTIPO,a.RCPSERIE,a.RCPNUMERO,a.CODIGONOTA,a.MOTIVONOTA,a.TIPOPAGO,a.FECHAVENCIMIENTO '+
        31         32        33         34            35               36            37           38             39           40
    TIPODSCTO, DSCTOUNIT, IGVTASA, a.ENVIOSUNAT, a.DSCTOGLOBAL, a.CARGOGLOBAL, a.CAT15_ELEM1,a.CAT15_ELEM2,a.CAT15_ELEM3,a.CAT15_ELEM4,
       41       42               43
    GLOSA,a.TIPOOPERACION,a.TOTALANTICIPOS

   //       0            1         2           3          4      5         6        7        8
   'SELECT a.ITEM, a.CANTIDAD, Unidad, a.DESCRIPCION, a.PU, a.PU_OR, a.VVUNIT,  a.DSCTO, a.CARGO, '+
   //   9       10     11          12                13          14         15          16           17
   'a.VVITEM, a.ISC, a.IGV, a.TIPOOPERACION, a.TIPOAFECTACION, a.MONTO, a.SUBTOTAL, a.PRODUCTO, a.CodigoSUNAT,
   //   18             19        20          21           22
   'a.TIPODSCTO, a.DSCTOUNIT, a.BOLSAS, a.TASAICBPER, a.ICBPER'+
   }


  MONEDA:=DM1.ZRegVen.Fields[9].AsString;
  importe1001_BIM  :=StrR2(ValR(DM1.ZRegVen.fields[10].AsString),12,CEROS_XML);
  importe1002_INA  :=StrR2(ValR(DM1.ZRegVen.fields[11].AsString),12,CEROS_XML);
  importe1003_EXO  :=StrR2(ValR(DM1.ZRegVen.fields[12].AsString),12,CEROS_XML);
  importe1004_GRA  :=StrR2(ValR(DM1.ZRegVen.fields[13].AsString),12,CEROS_XML);
  TOTAL_BRUTO      :=StrR2(ValR(importe1001_BIM)+ValR('0')+ValR(importe1003_EXO),12,CEROS_XML);
  TOTAL_IGV        :=StrR2(ValR(DM1.ZRegVen.fields[14].AsString),12,CEROS_XML);
  TOTAL_IMPUESTOS  :=StrR2(ValR(DM1.ZRegVen.fields[14].AsString)+ValR(DM1.ZRegVen.fields[15].AsString),12,CEROS_XML);   // IGV + ISC +
  OTROS_TRIBUTOS   :=StrR2(ValR(DM1.ZRegVen.fields[16].AsString),12,CEROS_XML);
  TOTAL_DESCUENTOS :=StrR2(ValR(DM1.ZRegVen.fields[17].AsString),12,CEROS_XML);
  TOTAL_CARGOS     :=StrR2(ValR(DM1.ZRegVen.fields[18].AsString),12,CEROS_XML);
  IMPORTE_TOTAL    :=StrR2(ValR(DM1.ZRegVen.fields[19].AsString),12,CEROS_XML);
  SUMRESUMEN       :=ValR(DM1.ZRegVen.fields[19].AsString);
  DSCTO_GLOBAL     :=StrR2(ValR(DM1.ZRegVen.fields[35].AsString),12,CEROS_XML);
  CARGO_GLOBAL     :=StrR2(ValR(DM1.ZRegVen.fields[36].AsString),12,CEROS_XML);

  TIPO_DOC_CLIENTE:=DM1.ZRegVen.fields[6].AsString;
  NRO_DOC_CLIENTE:=DM1.ZRegVen.fields[7].AsString;
  RAZON_NOMBRE_CLIENTE:=DM1.ZRegVen.fields[8].AsString;

     if TIPO_DOC_CLIENTE='0' THEN     // BOLETA SIN DOCUMENTO
      begin
         NRO_DOC_CLIENTE:='-';
      END;

    if TIPO_DOC_CLIENTE='4' then
     if NOT (CARNET_EXTRANJERIA='SI') then
       begin
          TIPO_DOC_CLIENTE:='0';
          NRO_DOC_CLIENTE:='-';
        end;

    if concdata then
     begin
       XMLdoc.active:=True;
       NodoRazonEmpresa1 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoRazonEmpresa2 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoRazonEmpresa3 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoNombreCliente :=XMLDoc.CreateNode (RAZON_NOMBRE_CLIENTE, ntCDATA);
     end;

  BtnLevantarDetallesVentaClick(NIL);

  cpe:=NewInvoice;

  cpe.UBLExtensions.Add;
  cpe.UBLExtensions.UBLExtension[0].AddChild('ext:ExtensionContent');

  cpe.UBLVersionID.Text:='2.1';
  cpe.CustomizationID.Text:='2.0';
  cpe.ID.Text:=DM1.ZRegVen.Fields[4].AsString+'-'+CompletarCadena(DM1.ZRegVen.Fields[5].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // serie - numero
  cpe.IssueDate.Text:=Copy(DM1.ZRegVen.Fields[1].AsString,7,4)+'-'+
                      Copy(DM1.ZRegVen.Fields[1].AsString,4,2)+'-'+
                      Copy(DM1.ZRegVen.Fields[1].AsString,1,2);   // fecha de emision

  cpe.IssueTime.Text:=totime24(Trim(DM1.ZRegVen.Fields[2].AsString));   // hora de emision

  cpe.InvoiceTypeCode.Text:=Comp2(DM1.ZRegVen.Fields[3].AsString);        // codigo de tipo documento Catalogo 01
  cpe.InvoiceTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
  cpe.InvoiceTypeCode.SetAttributeNS('listID','','0101');                 // venta interna
  cpe.InvoiceTypeCode.SetAttributeNS('listName','','Tipo de Documento');
  cpe.InvoiceTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo01');

  cpe.Note.Add;
  cpe.Note.Items[0].Text:=NumeroToLetra(ValR(StrR2(ValR(DM1.ZRegVen.Fields[19].AsString),12,CEROS_XML)));
  cpe.Note.Items[0].SetAttributeNS('languageLocaleID','','1000');     // Catalogo 52  1000 IMPORTE EN LETRAS
  // cat15 SUNAT    2001 bienes amazonia,  2002 servicios amazonia ETC
  for i := 37 to 40 do
    if DM1.ZRegVen.Fields[i].AsString<>'' then
     begin
        ActivaDM1ConsultaSQL('SELECT a.VALOR FROM CATALOGO15SUNAT a WHERE a.CODIGO="'+DM1.ZRegVen.Fields[i].AsString+'";',false);
        cpe.Note.Add;
        cpe.Note.Items[cpe.Note.Count-1].Text:=DM1.ConsultaSQL.Fields[0].AsString;
        cpe.Note.Items[cpe.Note.Count-1].SetAttributeNS('languageLocaleID','',DM1.ZRegVen.Fields[i].AsString);
     end;
  DM1.ConsultaSQL.Close;
  if ENVIAR_GLOSA_A_SUNAT='SI' then
   begin
   if trim(DM1.ZRegVen.Fields[41].AsString)<>'' then
    begin
     cpe.Note.Add;
     cpe.Note.Items[cpe.Note.Count-1].Text:=DM1.ZRegVen.Fields[41].AsString;
    end;
   end;

  cpe.DocumentCurrencyCode.Text:=MONEDA;
  cpe.DocumentCurrencyCode.SetAttributeNS('listID','','ISO 4217 Alpha');
  cpe.DocumentCurrencyCode.SetAttributeNS('listName','','Currency');
  cpe.DocumentCurrencyCode.SetAttributeNS('listAgencyName','','United Nations Economic Commission for Europe');


  //cpe.LineCountNumeric.Text:=StrI(DM1.ZDetVen.RecordCount); // cantidad de Items no envia NubeFact
  //cpe.OrderReference.ID.Text:='4574125';                    // Numero de la orden de compra

  if (DM1.ZRegVen.Fields[20].AsString)<>'' then  // si hay guias de remision
   begin
    cpe.DespatchDocumentReference.Add;
    cpe.DespatchDocumentReference.Items[0].ID.Text:=DM1.ZRegVen.Fields[20].AsString;
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.Text:=completar2(DM1.ZRegVen.Fields[21].AsString);
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listName','','Tipo de Documento');
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo01');
   end;

  { para otro tipo de documento como por ejemplo SCOP
  <cac:AdditionalDocumentReference>
  <cbc:ID>024099</cbc:ID>
  <cbc:DocumentTypeCode listAgencyName="PE:SUNAT" listName="SUNAT: Identificador de documento relacionado" listURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo12">99</cbc:DocumentTypeCode>
  </cac:AdditionalDocumentReference>
  }
  // si hay anticipos
  if ValR(DM1.ZRegVen.Fields[43].AsString)>0 then
   begin                                 //0            1          2
     ActivaDM1ConsultaSQL('SELECT (select r.tipocomprobante from registroventas r where r.dual=a.ASIENTOORIGEN), '+
     'a.SERIE, a.NUMERO, '+
     '(select case '+
     'when r.tipocomprobante=1 then 02 '+
     'when r.TIPOCOMPROBANTE=3 then 03 '+
     'else 99 '+
     'end as TipoReferencia '+
     'from registroventas r where r.dual=a.ASIENTOORIGEN), '+
     '(select r.TIPODOCUMENTO from registroventas r where r.dual=a.ASIENTOORIGEN), '+
     '(select r.NRODOCUMENTO  from registroventas r where r.dual=a.ASIENTOORIGEN) '+
     'FROM ANTICIPOS a  '+
     'where a.ASIENTODESTINO = '+DM1.ZRegVen.Fields[0].AsString,true);
     if DM1.ConsultaSQL.RecordCount>0 then
      begin
        for j := 1 to DM1.ConsultaSQL.RecordCount do
         begin
           if j>1 then DM1.ConsultaSQL.Next;
             cpe.AdditionalDocumentReference.Add;
                cpe.AdditionalDocumentReference.Items[j-1].ID.text:=DM1.ConsultaSQL.Fields[1].AsString+'-'+comp8(DM1.ConsultaSQL.Fields[2].AsString);
                cpe.AdditionalDocumentReference.Items[j-1].ID.SetAttributeNS('schemeID','',comp2(DM1.ConsultaSQL.Fields[0].AsString));

                cpe.AdditionalDocumentReference.Items[j-1].DocumentTypeCode.text:=comp2(DM1.ConsultaSQL.Fields[3].AsString);
                cpe.AdditionalDocumentReference.Items[j-1].DocumentTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo12');
                cpe.AdditionalDocumentReference.Items[j-1].DocumentTypeCode.SetAttributeNS('listName','','Documento Relacionado');
                cpe.AdditionalDocumentReference.Items[j-1].DocumentTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');

                cpe.AdditionalDocumentReference.Items[j-1].DocumentStatusCode.text:='1';
                cpe.AdditionalDocumentReference.Items[j-1].DocumentStatusCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.AdditionalDocumentReference.Items[j-1].DocumentStatusCode.SetAttributeNS('listName','','Anticipo');

                cpe.AdditionalDocumentReference.Items[j-1].IssuerParty.PartyIdentification.add;
                   cpe.AdditionalDocumentReference.Items[j-1].IssuerParty.PartyIdentification.items[0].ID.Text:=DM1.ConsultaSQL.Fields[5].AsString;
                   cpe.AdditionalDocumentReference.Items[j-1].IssuerParty.PartyIdentification.items[0].ID.SetAttributeNS('schemeName','','Documento de Identidad');
                   cpe.AdditionalDocumentReference.Items[j-1].IssuerParty.PartyIdentification.items[0].ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
                   cpe.AdditionalDocumentReference.Items[j-1].IssuerParty.PartyIdentification.items[0].ID.SetAttributeNS('schemeID','',DM1.ConsultaSQL.Fields[4].AsString);
                   cpe.AdditionalDocumentReference.Items[j-1].IssuerParty.PartyIdentification.items[0].ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06');
         end;
      end;
      DM1.ConsultaSQL.Close;
   end;

  cpe.Signature.Add;
     cpe.Signature.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].Note.Add;
     cpe.Signature.Items[0].Note.Items[0].Text:='EcorsaSoft';
     cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Add;
       cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].SignatoryParty.PartyName.Add;
       if not concdata then
          cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.text:=EliminaProhibidos(RAZON_EMPRESA)
       else
          cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.ChildNodes.add(NodoRazonEmpresa1);

     cpe.Signature.Items[0].DigitalSignatureAttachment.ExternalReference.URI.Text:=RUC_EMPRESA;

   //INFORMACION DEL EMISOR
   cpe.AccountingSupplierParty.Party.PartyIdentification.Add;
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeID','','6');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeName','','Documento de Identidad');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06');
   cpe.AccountingSupplierParty.Party.PartyName.Add;
     if not concdata then
       cpe.AccountingSupplierParty.Party.PartyName.Items[0].Name.Text:=EliminaProhibidos(RAZON_EMPRESA)
     else
       cpe.AccountingSupplierParty.Party.PartyName.Items[0].Name.ChildNodes.add(NodoRazonEmpresa2);
   cpe.AccountingSupplierParty.Party.PartyLegalEntity.Add;
     if not concdata then
        cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=EliminaProhibidos(RAZON_EMPRESA)
     else
        cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoRazonEmpresa3);
     cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationAddress.AddressTypeCode.Text:=CODIGO_LOCAL_ANEXO;  // CODIGO_LOCAL_ANEXO

   //INFORMACION DEL CLIENTE
   cpe.AccountingCustomerParty.Party.PartyIdentification.Add;
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.Text:=NRO_DOC_CLIENTE;
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeID','',TIPO_DOC_CLIENTE);
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeName','','Documento de Identidad');
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06');
   cpe.AccountingCustomerParty.Party.PartyLegalEntity.Add;
     if not concdata then
        cpe.AccountingCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=EliminaProhibidos(RAZON_NOMBRE_CLIENTE)
     else
        cpe.AccountingCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoNombreCliente);


  // 03/03/2021
  cpe.PaymentTerms.Add;
   cpe.PaymentTerms.Items[0].ID.Text:='FormaPago';

  if (DM1.ZRegVen.Fields[29].AsString='1') and ((Variables.get('FORZAR_CONTADO','')<>'SI')) then
   begin
       cpe.PaymentTerms.Items[0].PaymentMeansID.Add;
         cpe.PaymentTerms.Items[0].PaymentMeansID.Items[0].Text:='Credito';
       cpe.PaymentTerms.Items[0].Amount.Text:=IMPORTE_TOTAL;
       cpe.PaymentTerms.Items[0].Amount.SetAttributeNS('currencyID','',MONEDA);

     cpe.PaymentTerms.Add;
       cpe.PaymentTerms.Items[1].ID.text:='FormaPago';
       cpe.PaymentTerms.Items[1].PaymentMeansID.add;
         cpe.PaymentTerms.Items[1].PaymentMeansID.items[0].Text:='Cuota001';
       cpe.PaymentTerms.Items[1].Amount.Text:=IMPORTE_TOTAL;
       cpe.PaymentTerms.Items[1].Amount.SetAttributeNS('currencyID','',MONEDA);
       if BuscaSTR(DM1.ZRegVen.Fields[30].AsString,'-') then
          cpe.PaymentTerms.Items[1].PaymentDueDate.Text:=DM1.ZRegVen.Fields[30].AsString
       else
          cpe.PaymentTerms.Items[1].PaymentDueDate.Text:=Copy(DM1.ZRegVen.Fields[30].AsString,7,4)+'-'+
                            Copy(DM1.ZRegVen.Fields[30].AsString,4,2)+'-'+  //
                            Copy(DM1.ZRegVen.Fields[30].AsString,1,2);      // fecha de vencimiento
   end
  else
   begin
       cpe.PaymentTerms.Items[0].PaymentMeansID.Add;
         cpe.PaymentTerms.Items[0].PaymentMeansID.Items[0].Text:='Contado';
   end;



   // INFORMACION DE DSCTOS GLOBALES
   if ValI(DSCTO_GLOBAL)<>0 then
    begin
      cpe.AllowanceCharge.Add;
       cpe.AllowanceCharge.Items[0].ChargeIndicator.Text:='false';           // catalogo 53
       cpe.AllowanceCharge.Items[0].AllowanceChargeReasonCode.Text:='00';    // cat 53
       //cpe.AllowanceCharge.Items[0].MultiplierFactorNumeric.Text:=DM1.ZRegVen.Fields[32].AsString;
       cpe.AllowanceCharge.Items[0].Amount.Text:= DSCTO_GLOBAL;
         cpe.AllowanceCharge.Items[0].Amount.SetAttributeNS('currencyID','',MONEDA);
       cpe.AllowanceCharge.Items[0].BaseAmount.Text:= StrR(Valr(TOTAL_BRUTO) + Valr(DSCTO_GLOBAL));
         cpe.AllowanceCharge.Items[0].BaseAmount.SetAttributeNS('currencyID','',MONEDA);
    end;


   // INFORMACION DE IMPUESTOS
    cpe.TaxTotal.Add;
      cpe.TaxTotal.Items[0].TaxAmount.Text:=TOTAL_IMPUESTOS;
      cpe.TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

      i:=-1;
      if ValR(importe1001_BIM)<>0 then  // VENTAS GRAVADAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1001_BIM;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=TOTAL_IGV;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='S';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='1000';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='IGV';        //nombre tributo
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT'; // codigo internacional
        end;

      if ValR(importe1002_INA)<>0 then  // VENTAS INAFECTAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1002_INA;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=TOTAL_IGV;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='O';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9998';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='INA';        //nombre tributo
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE'; // codigo internacional
        end;

      if ValR(importe1003_EXO)<>0 then  // VENTAS EXONERADAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1003_EXO;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:='0.00';
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='E';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9997';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='EXO';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
        end;


      if ValR(importe1004_GRA)<>0 then  // VENTAS GRATUITAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1004_GRA;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:='0.00';
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='O';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9996';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='GRA';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
        end;

      if ValR(OTROS_TRIBUTOS)<>0 then  // IMPUESTO A LAS BOLSAS 21/12  ICBPER Linea 802
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=OTROS_TRIBUTOS;
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=OTROS_TRIBUTOS;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='S';

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='7152';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='ICBPER';        //nombre tributo
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='OTH'; // codigo internacional
        end;


    //INFORMACION DE TOTALES
    // es lo que seria la linea pero incluido los dsctos
    cpe.LegalMonetaryTotal.LineExtensionAmount.Text:=StrR(Valr(TOTAL_BRUTO) + Valr(DSCTO_GLOBAL) );
    cpe.LegalMonetaryTotal.LineExtensionAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.TaxInclusiveAmount.Text:=IMPORTE_TOTAL;
    cpe.LegalMonetaryTotal.TaxInclusiveAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.AllowanceTotalAmount.Text:=DSCTO_GLOBAL;
    cpe.LegalMonetaryTotal.AllowanceTotalAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.ChargeTotalAmount.Text:='0.00';
    cpe.LegalMonetaryTotal.ChargeTotalAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.PrepaidAmount.Text:='0.00';
    cpe.LegalMonetaryTotal.PrepaidAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.PayableAmount.Text:=IMPORTE_TOTAL;
    cpe.LegalMonetaryTotal.PayableAmount.SetAttributeNS('currencyID','',MONEDA);


    //ITEMS DE PRODUCTOS
    DM1.ZDetVen.First;
    for i := 0 to DM1.ZDetVen.RecordCount-1 do
     begin
      if i>0 then DM1.ZDetVen.Next;

      cpe.InvoiceLine.Add;
        cpe.InvoiceLine.Items[i].ID.Text:=StrI(i+1);
        cpe.InvoiceLine.Items[i].InvoicedQuantity.Text:=StrR2(ValR(DM1.ZDetVen.fields[1].AsString),16,CEROS_XML_CANTIDAD);
          cpe.InvoiceLine.Items[i].InvoicedQuantity.SetAttributeNS('unitCode','',DM1.ZDetVen.fields[2].AsString);
          cpe.InvoiceLine.Items[i].InvoicedQuantity.SetAttributeNS('unitCodeListID','','UN/ECE rec 20');
          cpe.InvoiceLine.Items[i].InvoicedQuantity.SetAttributeNS('unitCodeListAgencyName','','United Nations Economic Commission for Europe');

        //SUBTOTAL O VALOR DE VENTA
        cpe.InvoiceLine.Items[i].LineExtensionAmount.Text:=StrR2(ValR(DM1.ZDetVen.fields[9].AsString),12,CEROS_XML);
          cpe.InvoiceLine.Items[i].LineExtensionAmount.SetAttributeNS('currencyID','',MONEDA);

        //PRECIOS DE REFERENCIA
        cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Add;
          if DM1.ZDetVen.fields[12].AsString<>'1004' then
            cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceAmount.Text:=StrR2(ValR(DM1.ZDetVen.fields[4].AsString),12,CEROS_PRECIOS)
          else
            cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceAmount.Text:=StrR2(ValR(DM1.ZDetVen.fields[5].AsString),12,CEROS_PRECIOS);

            cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceAmount.SetAttributeNS('currencyID','',MONEDA);

            if DM1.ZDetVen.fields[12].AsString<>'1004' then
                cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.Text:='01'
            else
                cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.Text:='02';
            cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listName','','Tipo de Precio');
            cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
            cpe.InvoiceLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo16');

        // INFORMACION DE DESCUENTOS
        if ValI(DM1.ZDetVen.Fields[7].AsString)<>0 then
          begin
            cpe.InvoiceLine.Items[i].AllowanceCharge.Add;
             cpe.InvoiceLine.Items[i].AllowanceCharge.Items[0].ChargeIndicator.Text:='false';           // catalogo 53
             cpe.InvoiceLine.Items[i].AllowanceCharge.Items[0].AllowanceChargeReasonCode.Text:='00';    // cat 53
             //cpe.InvoiceLine.Items[i].AllowanceCharge.Items[0].MultiplierFactorNumeric.Text:=DM1.ZDetVen.Fields[19].AsString;
             cpe.InvoiceLine.Items[i].AllowanceCharge.Items[0].Amount.Text:= StrR2( ValR(DM1.ZDetVen.Fields[7].AsString),12,CEROS_XML);
             cpe.InvoiceLine.Items[i].AllowanceCharge.Items[0].Amount.SetAttributeNS('currencyID','',MONEDA);
             cpe.InvoiceLine.Items[i].AllowanceCharge.Items[0].BaseAmount.Text:= StrR2( ValR(DM1.ZDetVen.Fields[1].AsString)*ValR(DM1.ZDetVen.Fields[6].AsString),12,CEROS_XML);
             cpe.InvoiceLine.Items[i].AllowanceCharge.Items[0].BaseAmount.SetAttributeNS('currencyID','',MONEDA);
          end;


        //IMPUESTOS POR ITEM XD, ten en cuenta que un item solo por SER 1001 o 1002 o 1003 o 1004 pero pueden contener el ICBPER
        if DM1.ZDetVen.Fields[12].AsString='1001' then //GRAVADAS
         begin
          cpe.InvoiceLine.Items[i].TaxTotal.Add;
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[11].AsString)+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML);
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[11].AsString),12,CEROS_XML);
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='S';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='1000';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='IGV';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
         end;

        if (DM1.ZDetVen.Fields[12].AsString='1002') then //INAFECTAS
         begin
          cpe.InvoiceLine.Items[i].TaxTotal.Add;
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR('0.00')+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); // ina + icbper
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='O';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9998';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='INA';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
         end;

        if (DM1.ZDetVen.Fields[12].AsString='1003')  then //exonerads
         begin
          cpe.InvoiceLine.Items[i].TaxTotal.Add;
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:= StrR2( ValR('0.00')+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); // exo+ icbper
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='E';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9997';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='EXO';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
         end;

        if (DM1.ZDetVen.Fields[12].AsString='1004') then //GRATUITAS
         begin
          cpe.InvoiceLine.Items[i].TaxTotal.Add;
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:='0.00';
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML); //'0.00';
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='O';
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='0.00'; //StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9996';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='GRA';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
         end;

        if (ValR(OTROS_TRIBUTOS)<>0) and (ValR(DM1.ZDetVen.Fields[22].AsString)>0) then //ICBPER 21-12-2019 item Line Linea 1002 22/01/20
         begin
          //cpe.InvoiceLine.Items[i].TaxTotal.Add;
            //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR(OTROS_TRIBUTOS),12,CEROS_XML);
            //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

            //20 bolsas   21 tasa    22 impuesto
            cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); //Impuesto
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].BaseUnitMeasure.Text:=StrR2( ValR(DM1.ZDetVen.Fields[20].AsString),12,0);   // bolsas cantidad
                cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].BaseUnitMeasure.SetAttributeNS('unitCode','',DM1.ZDetVen.Fields[2].AsString);

              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='S';
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.Percent.Text:=StrR2( 0.00,12,CEROS_XML);
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.PerUnitAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[20].AsString),12,CEROS_XML);  // tasa icbper
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.PerUnitAmount.SetAttributeNS('currencyID','',MONEDA);

              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.Text:='7152';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.Name.Text:='ICBPER';
              cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.TaxTypeCode.Text:='OTH';
         end;

        //DETALLES DEL ITEM
        cpe.InvoiceLine.Items[i].Item.Description.Add;
        cpe.InvoiceLine.Items[i].Item.Description.Items[0].Text:=eliminaProhibidos(DM1.ZDetVen.Fields[3].AsString);
        cpe.InvoiceLine.Items[i].Item.SellersItemIdentification.ID.Text:=DM1.ZDetVen.Fields[16].AsString;
        if Trim(DM1.ZDetVen.Fields[17].AsString)<>'' then    // si hay codigo SUNAT
          begin
            cpe.InvoiceLine.Items[i].Item.CommodityClassification.Add;
            cpe.InvoiceLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.Text:=DM1.ZDetVen.Fields[17].AsString;
            //4252 cpe.InvoiceLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listID','','UNSPSC');
            //4252 cpe.InvoiceLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listAgencyName','','GS1 US');
            //4252 cpe.InvoiceLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listName','','Classification');
          end;

        if (Trim(DM1.ZRegVen.Fields[22].AsString)<>'') then  // SI HAY PLACA
          begin
            cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Add;
            cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[0].Name.Text:=Trim(DM1.ZRegVen.Fields[22].AsString);
            {cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[0].Name.Text:='Gastos Art. 37 Renta: Numero de Placa';
            cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.Text:='7000';
              cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.SetAttributeNS('listName','','Propiedad del item');
              cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
            cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[0].Value.Text:=DM1.ZRegVen.Fields[22].AsString;}
          end;

        if get_variable_sfs('PROPIEDADESITEM')<>'' then
         begin
           // PROPIEDADESITEM=Marca,5012|Modelo|Año modelo,5021|Color,5014|Motor,5015|Chasis,5019
            ActivaDM1ConsultaSQL('SELECT p.CAMPO1, p.VALOR1, p.CAMPO2, p.VALOR2, p.CAMPO3, p.VALOR3, p.CAMPO4, p.VALOR4, '+
                                 'p.CAMPO5, p.VALOR5, p.CAMPO6, p.VALOR6, p.CAMPO7, p.VALOR7, p.CAMPO8, p.VALOR8, p.CAMPO9, p.VALOR9, '+
                                 'p.CAMPO10, p.VALOR10 '+
                                 'FROM DETALLEITEM('+DM1.ZRegVen.Fields[0].AsString+', '+DM1.ZDetVen.Fields[0].AsString+') p',true);
            if DM1.ConsultaSQL.RecordCount>0 then
              begin
              for j := 0 to 4 do
               begin
                if DM1.ConsultaSQL.Fields[j*2+1].AsString<>'' then
                 begin
                  cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Add;
                  k:=cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Count-1;
                  cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[k].Name.Text:=Trim(DM1.ConsultaSQL.Fields[j*2].AsString);
                    for l := 1 to 10 do
                     if splitCadena(get_variable_sfs('PROPIEDADESITEM'),'|',l)<>'' then
                      begin
                        if ( uppercase(splitCadena(splitCadena(get_variable_sfs('PROPIEDADESITEM'),'|',l),',',1))=Uppercase(DM1.ConsultaSQL.Fields[j*2].AsString)) then
                         begin
                           cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[k].NameCode.Text:=SplitCadena(splitCadena(get_variable_sfs('PROPIEDADESITEM'),'|',l),',',2);
                              cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[k].NameCode.SetAttributeNS('listName','','Propiedad del item');
                              cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[k].NameCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                              cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[k].NameCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo55');
                         end;
                      end;
                  cpe.InvoiceLine.Items[i].Item.AdditionalItemProperty.Items[k].Value.Text:=Trim(DM1.ConsultaSQL.Fields[j*2+1].AsString);
                 end;
               end;
              end;

         end;

        //PRECIO DE VENTA
        IF (DM1.ZDetVen.Fields[12].AsString='1004') then
          cpe.InvoiceLine.Items[i].Price.PriceAmount.Text:='0.0000'  // desagregado
        else
          cpe.InvoiceLine.Items[i].Price.PriceAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[6].AsString),12,CEROS_PRECIOS);  // desagregado
        cpe.InvoiceLine.Items[i].Price.PriceAmount.SetAttributeNS('currencyID','',MONEDA);
     end;


  xmldoc.XML.Text := FormatXMLData(cpe.XML);
  xmldoc.Active := true;
  xmldoc.Encoding :=codificadoXML;
  xmldoc.StandAlone:='no';
    //ShowMessage(archivo);
    xmldoc.SaveToFile(archivo);
  xmldoc.Active := false;
   if concdata then
     begin
       hoja.Lines.LoadFromFile(archivo);
       for i := 0  to hoja.Lines.Count-1 do
         begin
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'-=|','<');
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'|=-','>');
         end;
       hoja.Lines.SaveToFile(archivo);
       hoja.Clear;
     end;
   Result:=0;
 end;



function TFrmGenCPE.GeneraCreditNote(dual : string; archivo : string; concdata : Boolean):Integer;
var cpe : IXMLCreditNoteType;
    i : Integer;
    MONEDA, importe1001_BIM, importe1002_INA, importe1003_EXO, importe1004_GRA,
    TOTAL_IGV, TOTAL_IMPUESTOS, TOTAL_DESCUENTOS, TOTAL_CARGOS, IMPORTE_TOTAL,
    TOTAL_BRUTO,TIPO_DOC_CLIENTE, NRO_DOC_CLIENTE,RAZON_NOMBRE_CLIENTE : string;
    DSCTO_GLOBAL, CARGO_GLOBAL,OTROS_TRIBUTOS : string;

    NodoRazonEmpresa1 : IXMLNode;
    NodoRazonEmpresa2 : IXMLNode;
    NodoRazonEmpresa3 : IXMLNode;
    NodoNombreCliente : IXMLNode;

 begin
  {
  //               0            1            2           3            4           5           6              7               8
  'select a.'+IDDUAL+',a.FECHAEMISION,a.HORA,a.TIPOCOMPROBANTE,a.SERIECO,a.NUMEROCO,a.TIPODOCUMENTO,a.NRODOCUMENTO,a.RAZONNOMBRE, '+
  //  9                   10                              11                             12
  'a.MONEDA,abs(a.BASEIMPONIBLE) AS BASEIMPONIBLE,abs(a.INAFECTAS) AS INAFECTAS,abs(a.TOTALEXONERADA) AS TOTALEXONERADA,'+
  //              13                    14                       15                      16
  'abs(a.GRATUITAS) AS GRATUITAS,abs(a.IGVIPM) AS IGVIPM,abs(a.ISC) AS ISC,abs(a.OTROSTRIBUTOS) AS OTROSTRIBUTOS,'+
  //            17                          18                             19                        20            21
  'abs(a.DESCUENTOS) AS DESCUENTOS,abs(a.CARGOS) AS CARGOS, abs(a.IMPORTETOTAL) AS IMPORTETOTAL,a.GUIAREMISION,a.TIPOGUIA,'+
  //   22                 23                   24         25          26          27          28           29             30
  ' a.PLACA,abs(a.PERCEPCION) AS PERCEPCION,a.RCPTIPO,a.RCPSERIE,a.RCPNUMERO,a.CODIGONOTA,a.MOTIVONOTA,a.TIPOPAGO,a.FECHAVENCIMIENTO '+
        31         32        33
    TIPODSCTO, DSCTOUNIT, IGVTASA

   //       0            1         2           3          4      5         6        7        8
   'SELECT a.ITEM, a.CANTIDAD, Unidad, a.DESCRIPCION, a.PU, a.PU_OR, a.VVUNIT,  a.DSCTO, a.CARGO, '+
   //   9       10     11          12                13          14         15          16           17
   'a.VVITEM, a.ISC, a.IGV, a.TIPOOPERACION, a.TIPOAFECTACION, a.MONTO, a.SUBTOTAL, a.PRODUCTO, a.CodigoSUNAT '+
   //   18             19        20          21           22
   'a.TIPODSCTO, a.DSCTOUNIT, a.BOLSAS, a.TASAICBPER, a.ICBPER'+
   }

  MONEDA:=DM1.ZRegVen.Fields[9].AsString;
  importe1001_BIM  :=StrR2(ValR(DM1.ZRegVen.fields[10].AsString),12,CEROS_XML);
  importe1002_INA  :=StrR2(ValR(DM1.ZRegVen.fields[11].AsString),12,CEROS_XML);
  importe1003_EXO  :=StrR2(ValR(DM1.ZRegVen.fields[12].AsString),12,CEROS_XML);
  importe1004_GRA  :=StrR2(ValR(DM1.ZRegVen.fields[13].AsString),12,CEROS_XML);
  TOTAL_BRUTO      :=StrR2(ValR(importe1001_BIM)+ValR('0')+ValR(importe1003_EXO),12,CEROS_XML);
  TOTAL_IGV        :=StrR2(ValR(DM1.ZRegVen.fields[14].AsString),12,CEROS_XML);
  TOTAL_IMPUESTOS  :=StrR2(ValR(DM1.ZRegVen.fields[14].AsString)+ValR(DM1.ZRegVen.fields[15].AsString),12,CEROS_XML);   // IGV + ISC +
  OTROS_TRIBUTOS   :=StrR2(ValR(DM1.ZRegVen.fields[16].AsString),12,CEROS_XML);
  TOTAL_DESCUENTOS :=StrR2(ValR(DM1.ZRegVen.fields[17].AsString),12,CEROS_XML);
  TOTAL_CARGOS     :=StrR2(ValR(DM1.ZRegVen.fields[18].AsString),12,CEROS_XML);
  IMPORTE_TOTAL    :=StrR2(ValR(DM1.ZRegVen.fields[19].AsString),12,CEROS_XML);
  SUMRESUMEN       :=ValR(DM1.ZRegVen.fields[19].AsString);
  DSCTO_GLOBAL     :=StrR2(ValR(DM1.ZRegVen.fields[35].AsString),12,CEROS_XML);
  CARGO_GLOBAL     :=StrR2(ValR(DM1.ZRegVen.fields[36].AsString),12,CEROS_XML);

  TIPO_DOC_CLIENTE:=DM1.ZRegVen.fields[6].AsString;
  NRO_DOC_CLIENTE:=DM1.ZRegVen.fields[7].AsString;
  RAZON_NOMBRE_CLIENTE:=DM1.ZRegVen.fields[8].AsString;

     if TIPO_DOC_CLIENTE='0' THEN     // BOLETA SIN DOCUMENTO
      begin
         NRO_DOC_CLIENTE:='-';
      END;

    if TIPO_DOC_CLIENTE='4' then
     if NOT (CARNET_EXTRANJERIA='SI') then
       begin
          TIPO_DOC_CLIENTE:='0';
          NRO_DOC_CLIENTE:='-';
        end;

    if concdata then
     begin
       XMLdoc.active:=True;
       NodoRazonEmpresa1 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoRazonEmpresa2 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoRazonEmpresa3 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoNombreCliente :=XMLDoc.CreateNode (RAZON_NOMBRE_CLIENTE, ntCDATA);
     end;

  BtnLevantarDetallesVentaClick(NIL);

  cpe:=NewCreditNote;

  cpe.UBLExtensions.Add;
  cpe.UBLExtensions.UBLExtension[0].AddChild('ext:ExtensionContent');

  cpe.UBLVersionID.Text:='2.1';
  cpe.CustomizationID.Text:='2.0';
  cpe.ID.Text:=DM1.ZRegVen.Fields[4].AsString+'-'+CompletarCadena(DM1.ZRegVen.Fields[5].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // serie - numero
  cpe.IssueDate.Text:=Copy(DM1.ZRegVen.Fields[1].AsString,7,4)+'-'+
                      Copy(DM1.ZRegVen.Fields[1].AsString,4,2)+'-'+
                      Copy(DM1.ZRegVen.Fields[1].AsString,1,2);   // fecha de emision
  cpe.IssueTime.Text:=totime24(DM1.ZRegVen.Fields[2].AsString);              // hora de emision

  //Codigo interno generado por el software de facturacion
  {cpe.Note.Add;
  cpe.Note.Items[0].Text:='0501002017062500125';
  cpe.Note.Items[0].SetAttributeNS('languageLocaleID','','3000'); // Catalogo 52}
  cpe.Note.Add;
  cpe.Note.Items[0].Text:=NumeroToLetra(ValR(StrR2(ValR(DM1.ZRegVen.Fields[19].AsString),12,CEROS_XML)));
  cpe.Note.Items[0].SetAttributeNS('languageLocaleID','','1000');     // Catalogo 52  1000 IMPORTE EN LETRAS
  // cat15 SUNAT    2001 bienes amazonia,  2002 servicios amazonia ETC
  for i := 37 to 40 do
    if DM1.ZRegVen.Fields[i].AsString<>'' then
     begin
        ActivaDM1ConsultaSQL('SELECT a.VALOR FROM CATALOGO15SUNAT a WHERE a.CODIGO="'+DM1.ZRegVen.Fields[i].AsString+'";',false);
        cpe.Note.Add;
        cpe.Note.Items[cpe.Note.Count-1].Text:=DM1.ConsultaSQL.Fields[0].AsString;
        cpe.Note.Items[cpe.Note.Count-1].SetAttributeNS('languageLocaleID','',DM1.ZRegVen.Fields[i].AsString);
     end;
  DM1.ConsultaSQL.Close;
  if ENVIAR_GLOSA_A_SUNAT='SI' then
   begin
     cpe.Note.Add;
     cpe.Note.Items[cpe.Note.Count-1].Text:=DM1.ZRegVen.Fields[41].AsString;
   end;

  cpe.DocumentCurrencyCode.Text:=MONEDA;

  // RCPs del documento
  cpe.DiscrepancyResponse.Add;
    cpe.DiscrepancyResponse.Items[0].ReferenceID.Text:=DM1.ZRegVen.Fields[25].AsString+'-'+CompletarCadena(DM1.ZRegVen.Fields[26].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // RCP serie - numero
    cpe.DiscrepancyResponse.Items[0].ResponseCode.Text:=DM1.ZRegVen.Fields[27].AsString;
    cpe.DiscrepancyResponse.Items[0].Description.Add;
      cpe.DiscrepancyResponse.Items[0].Description.Items[0].Text:=DM1.ZRegVen.Fields[28].AsString;

  // Tipo de documento al que se apunta
  cpe.BillingReference.Add;
    cpe.BillingReference.Items[0].InvoiceDocumentReference.ID.Text:=DM1.ZRegVen.Fields[25].AsString+'-'+CompletarCadena(DM1.ZRegVen.Fields[26].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // RCP serie - numero
    cpe.BillingReference.Items[0].InvoiceDocumentReference.DocumentTypeCode.Text:=CompletarCadena(DM1.ZRegVen.Fields[24].AsString,'0',2);

  if (DM1.ZRegVen.Fields[20].AsString)<>'' then  // si hay guias de remision
   begin
    cpe.DespatchDocumentReference.Add;
    cpe.DespatchDocumentReference.Items[0].ID.Text:=DM1.ZRegVen.Fields[20].AsString;
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.Text:=completar2(DM1.ZRegVen.Fields[21].AsString);
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listName','','Tipo de Documento');
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo01');
   end;

  // si hubiera mas documentos relacionados, liquidaciones, etc
  //cpe.AdditionalDocumentReference.Add;

  cpe.Signature.Add;
     cpe.Signature.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].Note.Add;
     cpe.Signature.Items[0].Note.Items[0].Text:='EcorsaSoft';
     cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Add;
       cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].SignatoryParty.PartyName.Add;
       if not concdata then
         cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.Text:=EliminaProhibidos(RAZON_EMPRESA)
       else
         cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.ChildNodes.add(NodoRazonEmpresa1);
     cpe.Signature.Items[0].DigitalSignatureAttachment.ExternalReference.URI.Text:=RUC_EMPRESA;

   cpe.AccountingSupplierParty.Party.PartyIdentification.Add;
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeID','','6');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeName','','Documento de Identidad');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06');
   cpe.AccountingSupplierParty.Party.PartyName.Add;
     if not concdata then
       cpe.AccountingSupplierParty.Party.PartyName.Items[0].Name.Text:=EliminaProhibidos(RAZON_EMPRESA)
     else
       cpe.AccountingSupplierParty.Party.PartyName.Items[0].Name.ChildNodes.add(NodoRazonEmpresa2);
   cpe.AccountingSupplierParty.Party.PartyLegalEntity.Add;
     if not concdata then
       cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=EliminaProhibidos(RAZON_EMPRESA)
     else
       cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoRazonEmpresa3);
     cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationAddress.AddressTypeCode.Text:=CODIGO_LOCAL_ANEXO;  // CODIGO_LOCAL_ANEXO

   cpe.AccountingCustomerParty.Party.PartyIdentification.Add;
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.Text:=NRO_DOC_CLIENTE;
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeID','',TIPO_DOC_CLIENTE);
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeName','','Documento de Identidad');
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06');
   cpe.AccountingCustomerParty.Party.PartyLegalEntity.Add;
     if not concdata then
       cpe.AccountingCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=EliminaProhibidos(RAZON_NOMBRE_CLIENTE)
     else
       cpe.AccountingCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoNombreCliente);


   // INFORMACION DE DSCTOS GLOBALES
   if ValI(DSCTO_GLOBAL)<>0 then
    begin
      cpe.AllowanceCharge.Add;
       cpe.AllowanceCharge.Items[0].ChargeIndicator.Text:='false';           // catalogo 53
       cpe.AllowanceCharge.Items[0].AllowanceChargeReasonCode.Text:='00';    // cat 53
       //cpe.AllowanceCharge.Items[0].MultiplierFactorNumeric.Text:=DM1.ZRegVen.Fields[32].AsString;
       cpe.AllowanceCharge.Items[0].Amount.Text:= DSCTO_GLOBAL;
         cpe.AllowanceCharge.Items[0].Amount.SetAttributeNS('currencyID','',MONEDA);
       cpe.AllowanceCharge.Items[0].BaseAmount.Text:= StrR(Valr(TOTAL_BRUTO) + Valr(DSCTO_GLOBAL));
         cpe.AllowanceCharge.Items[0].BaseAmount.SetAttributeNS('currencyID','',MONEDA);
    end;


   // INFORMACION DE IMPUESTOS
    cpe.TaxTotal.Add;
      cpe.TaxTotal.Items[0].TaxAmount.Text:=TOTAL_IMPUESTOS;
      cpe.TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

      i:=-1;
      if ValR(importe1001_BIM)<>0 then  // VENTAS GRAVADAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1001_BIM;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=TOTAL_IGV;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='S';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='1000';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='IGV';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
        end;

      if ValR(importe1002_INA)<>0 then  // VENTAS INAFECTAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1002_INA;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=TOTAL_IGV;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='O';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9998';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='INA';        //nombre tributo
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE'; // codigo internacional
        end;

      if ValR(importe1003_EXO)<>0 then  // VENTAS EXONERADAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1003_EXO;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:='0.00';
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='E';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9997';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='EXO';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
        end;


      if ValR(importe1004_GRA)<>0 then  // VENTAS GRATUITAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1004_GRA;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:='0.00';
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='O';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9996';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='GRA';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
        end;

      if ValR(OTROS_TRIBUTOS)<>0 then  // IMPUESTO A LAS BOLSAS 31/12  ICBPER Linea 802
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=OTROS_TRIBUTOS;
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=OTROS_TRIBUTOS;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='S';

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='7152';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='ICBPER';        //nombre tributo
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='OTH'; // codigo internacional
        end;


    //INFORMACION DE TOTALES
    // es lo que seria la linea pero incluido los dsctos
    cpe.LegalMonetaryTotal.LineExtensionAmount.Text:=StrR(Valr(TOTAL_BRUTO) + Valr(DSCTO_GLOBAL));
    cpe.LegalMonetaryTotal.LineExtensionAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.TaxInclusiveAmount.Text:=IMPORTE_TOTAL;
    cpe.LegalMonetaryTotal.TaxInclusiveAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.AllowanceTotalAmount.Text:=DSCTO_GLOBAL;
    cpe.LegalMonetaryTotal.AllowanceTotalAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.ChargeTotalAmount.Text:='0.00';
    cpe.LegalMonetaryTotal.ChargeTotalAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.PrepaidAmount.Text:='0.00';
    cpe.LegalMonetaryTotal.PrepaidAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.LegalMonetaryTotal.PayableAmount.Text:=IMPORTE_TOTAL;
    cpe.LegalMonetaryTotal.PayableAmount.SetAttributeNS('currencyID','',MONEDA);


    //ITEMS DE PRODUCTOS
    DM1.ZDetVen.First;
    for i := 0 to DM1.ZDetVen.RecordCount-1 do
     begin
      if i>0 then DM1.ZDetVen.Next;

      cpe.CreditNoteLine.Add;
        cpe.CreditNoteLine.Items[i].ID.Text:=StrI(i+1);
        cpe.CreditNoteLine.Items[i].CreditedQuantity.Text:=StrR2(ValR(DM1.ZDetVen.fields[1].AsString),16,CEROS_XML_CANTIDAD);
          cpe.CreditNoteLine.Items[i].CreditedQuantity.SetAttributeNS('unitCode','',DM1.ZDetVen.fields[2].AsString);
          cpe.CreditNoteLine.Items[i].CreditedQuantity.SetAttributeNS('unitCodeListID','','UN/ECE rec 20');
          cpe.CreditNoteLine.Items[i].CreditedQuantity.SetAttributeNS('unitCodeListAgencyName','','United Nations Economic Commission for Europe');

        //SUBTOTAL O VALOR DE VENTA
        cpe.CreditNoteLine.Items[i].LineExtensionAmount.Text:=StrR2(ValR(DM1.ZDetVen.fields[9].AsString),12,CEROS_XML);
          cpe.CreditNoteLine.Items[i].LineExtensionAmount.SetAttributeNS('currencyID','',MONEDA);

        //PRECIOS DE REFERENCIA
        cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Add;
          cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceAmount.Text:=StrR2(ValR(DM1.ZDetVen.fields[4].AsString),12,CEROS_PRECIOS);
            cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceAmount.SetAttributeNS('currencyID','',MONEDA);
            if DM1.ZDetVen.fields[12].AsString<>'1004' then
              cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.Text:='01'
            else
              cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.Text:='02';
            cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listName','','Tipo de Precio');
            cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
            cpe.CreditNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo16');

        // INFORMACION DE DESCUENTOS
        if (ValI(DM1.ZDetVen.Fields[7].AsString)<>0) and (false) then
          begin
            cpe.CreditNoteLine.Items[i].AllowanceCharge.Add;
             cpe.CreditNoteLine.Items[i].AllowanceCharge.Items[0].ChargeIndicator.Text:='false';           // catalogo 53
             cpe.CreditNoteLine.Items[i].AllowanceCharge.Items[0].AllowanceChargeReasonCode.Text:='00';    // cat 53
             //cpe.CreditNoteLine.Items[i].AllowanceCharge.Items[0].MultiplierFactorNumeric.Text:=DM1.ZDetVen.Fields[19].AsString;
             cpe.CreditNoteLine.Items[i].AllowanceCharge.Items[0].Amount.Text:= StrR2( ValR(DM1.ZDetVen.Fields[7].AsString),12,CEROS_XML);
             cpe.CreditNoteLine.Items[i].AllowanceCharge.Items[0].Amount.SetAttributeNS('currencyID','',MONEDA);
             cpe.CreditNoteLine.Items[i].AllowanceCharge.Items[0].BaseAmount.Text:= StrR2( ValR(DM1.ZDetVen.Fields[1].AsString)*ValR(DM1.ZDetVen.Fields[6].AsString),12,CEROS_XML);
             cpe.CreditNoteLine.Items[i].AllowanceCharge.Items[0].BaseAmount.SetAttributeNS('currencyID','',MONEDA);
          end;


        //IMPUESTOS POR ITEM XD
        if DM1.ZDetVen.Fields[12].AsString='1001' then //GRAVADAS
         begin
          cpe.CreditNoteLine.Items[i].TaxTotal.Add;
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[11].AsString)+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML);
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[11].AsString),12,CEROS_XML);
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='S';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='1000';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='IGV';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
         end;

        if (DM1.ZDetVen.Fields[12].AsString='1002') then //INAFECTAS
         begin
          cpe.CreditNoteLine.Items[i].TaxTotal.Add;
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR('0.00')+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); // ina + icbper
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='O';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9998';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='INA';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
         end;

        if  (DM1.ZDetVen.Fields[12].AsString='1003')  then //EXONERDAS
         begin
          cpe.CreditNoteLine.Items[i].TaxTotal.Add;
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR('0.00')+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); // exo + icbper
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='E';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9997';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='EXO';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
         end;

        if (DM1.ZDetVen.Fields[12].AsString='1004') then //GRATUITAS
         begin
          cpe.CreditNoteLine.Items[i].TaxTotal.Add;
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:='0.00';
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);//'0.00';
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='O';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9996';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='GRA';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
         end;

        if (ValR(OTROS_TRIBUTOS)<>0) and (ValR(DM1.ZDetVen.Fields[22].AsString)>0) then //ICBPER 21-12-2019 item Line Linea 1002 22/01/20
         begin
          //cpe.InvoiceLine.Items[i].TaxTotal.Add;
            //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR(OTROS_TRIBUTOS),12,CEROS_XML);
            //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

            cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); //Impuesto
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].BaseUnitMeasure.Text:=StrR2( ValR(DM1.ZDetVen.Fields[20].AsString),12,0);   // bolsas cantidad
                cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].BaseUnitMeasure.SetAttributeNS('unitCode','',DM1.ZDetVen.Fields[2].AsString);

              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='S';
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.Percent.Text:=StrR2( 0.00,12,CEROS_XML);
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.PerUnitAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[20].AsString),12,CEROS_XML);  //tasa icbper
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.PerUnitAmount.SetAttributeNS('currencyID','',MONEDA);

              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.Text:='7152';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.Name.Text:='ICBPER';
              cpe.CreditNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.TaxTypeCode.Text:='OTH';
         end;

        //DETALLES DEL ITEM
        cpe.CreditNoteLine.Items[i].Item.Description.Add;
        cpe.CreditNoteLine.Items[i].Item.Description.Items[0].Text:=EliminaProhibidos(DM1.ZDetVen.Fields[3].AsString);
        cpe.CreditNoteLine.Items[i].Item.SellersItemIdentification.ID.Text:=DM1.ZDetVen.Fields[16].AsString;
        if DM1.ZDetVen.Fields[17].AsString<>'' then // si hay codigo sunat
          begin
            cpe.CreditNoteLine.Items[i].Item.CommodityClassification.Add;
            cpe.CreditNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.Text:=DM1.ZDetVen.Fields[17].AsString;
            //4252 cpe.CreditNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listID','','UNSPSC');
            //4252 cpe.CreditNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listAgencyName','','GS1 US');
            //4252 cpe.CreditNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listName','','Classification');
          end;
        if Trim(DM1.ZRegVen.Fields[22].AsString)<>'' then  // SI HAY PLACA
          begin
            cpe.CreditNoteLine.Items[i].Item.AdditionalItemProperty.Add;
            cpe.CreditNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].Name.Text:=DM1.ZRegVen.Fields[22].AsString;
            {cpe.CreditNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].Name.Text:='Gastos Art. 37 Renta: Numero de Placa';
            cpe.CreditNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.Text:='7000';
              cpe.CreditNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.SetAttributeNS('listName','','Propiedad del item');
              cpe.CreditNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
            cpe.CreditNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].Value.Text:=DM1.ZRegVen.Fields[22].AsString;}
          end;

        //PRECIO DE VENTA
        IF (DM1.ZDetVen.Fields[12].AsString='1004') then
          cpe.CreditNoteLine.Items[i].Price.PriceAmount.Text:='0.0000'  // desagregado
        else
          cpe.CreditNoteLine.Items[i].Price.PriceAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[6].AsString),12,CEROS_PRECIOS);  // desagregado
        cpe.CreditNoteLine.Items[i].Price.PriceAmount.SetAttributeNS('currencyID','',MONEDA);

     end;


  xmldoc.XML.Text := FormatXMLData(cpe.XML);
  xmldoc.Active := true;
  xmldoc.Encoding :=codificadoXML;
  xmldoc.StandAlone:='no';
    xmldoc.SaveToFile(archivo);
  xmldoc.Active := false;
   if concdata then
     begin
       hoja.Lines.LoadFromFile(archivo);
       for i := 0  to hoja.Lines.Count-1 do
         begin
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'-=|','<');
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'|=-','>');
         end;
       hoja.Lines.SaveToFile(archivo);
       hoja.Clear;
     end;
   Result:=0;
 end;


function TFrmGenCPE.GeneraDebitNote(dual : string; archivo : string; concdata : Boolean):Integer;
var cpe : IXMLDebitNoteType;
    i : Integer;
    MONEDA, importe1001_BIM, importe1002_INA, importe1003_EXO, importe1004_GRA,
    TOTAL_IGV, TOTAL_IMPUESTOS, TOTAL_DESCUENTOS, TOTAL_CARGOS, IMPORTE_TOTAL,
    TOTAL_BRUTO,TIPO_DOC_CLIENTE, NRO_DOC_CLIENTE,RAZON_NOMBRE_CLIENTE : string;
    DSCTO_GLOBAL, CARGO_GLOBAL, OTROS_TRIBUTOS : string;

    NodoRazonEmpresa1 : IXMLNode;
    NodoRazonEmpresa2 : IXMLNode;
    NodoRazonEmpresa3 : IXMLNode;
    NodoNombreCliente : IXMLNode;
 begin
  {
  //               0            1            2           3            4           5           6              7               8
  'select a.'+IDDUAL+',a.FECHAEMISION,a.HORA,a.TIPOCOMPROBANTE,a.SERIECO,a.NUMEROCO,a.TIPODOCUMENTO,a.NRODOCUMENTO,a.RAZONNOMBRE, '+
  //  9                   10                              11                             12
  'a.MONEDA,abs(a.BASEIMPONIBLE) AS BASEIMPONIBLE,abs(a.INAFECTAS) AS INAFECTAS,abs(a.TOTALEXONERADA) AS TOTALEXONERADA,'+
  //              13                    14                       15                      16
  'abs(a.GRATUITAS) AS GRATUITAS,abs(a.IGVIPM) AS IGVIPM,abs(a.ISC) AS ISC,abs(a.OTROSTRIBUTOS) AS OTROSTRIBUTOS,'+
  //            17                          18                             19                        20            21
  'abs(a.DESCUENTOS) AS DESCUENTOS,abs(a.CARGOS) AS CARGOS, abs(a.IMPORTETOTAL) AS IMPORTETOTAL,a.GUIAREMISION,a.TIPOGUIA,'+
  //   22                 23                   24         25          26          27          28           29             30
  ' a.PLACA,abs(a.PERCEPCION) AS PERCEPCION,a.RCPTIPO,a.RCPSERIE,a.RCPNUMERO,a.CODIGONOTA,a.MOTIVONOTA,a.TIPOPAGO,a.FECHAVENCIMIENTO '+
        31         32        33
    TIPODSCTO, DSCTOUNIT, IGVTASA
   //       0            1         2           3          4      5         6        7        8
   'SELECT a.ITEM, a.CANTIDAD, Unidad, a.DESCRIPCION, a.PU, a.PU_OR, a.VVUNIT,  a.DSCTO, a.CARGO, '+
   //   9       10     11          12                13          14         15          16           17
   'a.VVITEM, a.ISC, a.IGV, a.TIPOOPERACION, a.TIPOAFECTACION, a.MONTO, a.SUBTOTAL, a.PRODUCTO, a.CodigoSUNAT '+
   //   18             19        20          21           22
   'a.TIPODSCTO, a.DSCTOUNIT, a.BOLSAS, a.TASAICBPER, a.ICBPER'+
   }

  MONEDA:=DM1.ZRegVen.Fields[9].AsString;
  importe1001_BIM  :=StrR2(ValR(DM1.ZRegVen.fields[10].AsString),12,CEROS_XML);
  importe1002_INA  :=StrR2(ValR(DM1.ZRegVen.fields[11].AsString),12,CEROS_XML);
  importe1003_EXO  :=StrR2(ValR(DM1.ZRegVen.fields[12].AsString),12,CEROS_XML);
  importe1004_GRA  :=StrR2(ValR(DM1.ZRegVen.fields[13].AsString),12,CEROS_XML);
  TOTAL_BRUTO      :=StrR2(ValR(importe1001_BIM)+ValR(importe1002_INA)+ValR(importe1003_EXO),12,CEROS_XML);
  TOTAL_IGV        :=StrR2(ValR(DM1.ZRegVen.fields[14].AsString),12,CEROS_XML);
  TOTAL_IMPUESTOS  :=StrR2(ValR(DM1.ZRegVen.fields[14].AsString)+ValR(DM1.ZRegVen.fields[15].AsString),12,CEROS_XML);   // IGV + ISC +
  OTROS_TRIBUTOS   :=StrR2(ValR(DM1.ZRegVen.fields[16].AsString),12,CEROS_XML);
  TOTAL_DESCUENTOS :=StrR2(ValR(DM1.ZRegVen.fields[17].AsString),12,CEROS_XML);
  TOTAL_CARGOS     :=StrR2(ValR(DM1.ZRegVen.fields[18].AsString),12,CEROS_XML);
  IMPORTE_TOTAL    :=StrR2(ValR(DM1.ZRegVen.fields[19].AsString),12,CEROS_XML);
  SUMRESUMEN       :=ValR(DM1.ZRegVen.fields[19].AsString);
  DSCTO_GLOBAL     :=StrR2(ValR(DM1.ZRegVen.fields[35].AsString),12,CEROS_XML);
  CARGO_GLOBAL     :=StrR2(ValR(DM1.ZRegVen.fields[36].AsString),12,CEROS_XML);

  TIPO_DOC_CLIENTE:=DM1.ZRegVen.fields[6].AsString;
  NRO_DOC_CLIENTE:=DM1.ZRegVen.fields[7].AsString;
  RAZON_NOMBRE_CLIENTE:=DM1.ZRegVen.fields[8].AsString;

     if TIPO_DOC_CLIENTE='0' THEN     // BOLETA SIN DOCUMENTO
      begin
         NRO_DOC_CLIENTE:='-';
      END;

    if TIPO_DOC_CLIENTE='4' then
     if NOT (CARNET_EXTRANJERIA='SI') then
       begin
          TIPO_DOC_CLIENTE:='0';
          NRO_DOC_CLIENTE:='-';
        end;

    if concdata then
     begin
       XMLdoc.active:=True;
       NodoRazonEmpresa1 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoRazonEmpresa2 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoRazonEmpresa3 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
       NodoNombreCliente :=XMLDoc.CreateNode (RAZON_NOMBRE_CLIENTE, ntCDATA);
     end;

  BtnLevantarDetallesVentaClick(NIL);

  cpe:=NewDebitNote;

  cpe.UBLExtensions.Add;
  cpe.UBLExtensions.UBLExtension[0].AddChild('ext:ExtensionContent');

  cpe.UBLVersionID.Text:='2.1';
  cpe.CustomizationID.Text:='2.0';
  cpe.ID.Text:=DM1.ZRegVen.Fields[4].AsString+'-'+CompletarCadena(DM1.ZRegVen.Fields[5].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // serie - numero
  cpe.IssueDate.Text:=Copy(DM1.ZRegVen.Fields[1].AsString,7,4)+'-'+
                      Copy(DM1.ZRegVen.Fields[1].AsString,4,2)+'-'+
                      Copy(DM1.ZRegVen.Fields[1].AsString,1,2);   // fecha de emision
  cpe.IssueTime.Text:=totime24(DM1.ZRegVen.Fields[2].AsString);              // hora de emision

  //Codigo interno generado por el software de facturacion
  {cpe.Note.Add;
  cpe.Note.Items[0].Text:='0501002017062500125';
  cpe.Note.Items[0].SetAttributeNS('languageLocaleID','','3000'); // Catalogo 52}
  cpe.Note.Add;
  cpe.Note.Items[0].Text:=NumeroToLetra(ValR(StrR2(ValR(DM1.ZRegVen.Fields[19].AsString),12,CEROS_XML)));
  cpe.Note.Items[0].SetAttributeNS('languageLocaleID','','1000');     // Catalogo 52  1000 IMPORTE EN LETRAS
  // cat15 SUNAT    2001 bienes amazonia,  2002 servicios amazonia ETC
  for i := 37 to 40 do
    if DM1.ZRegVen.Fields[i].AsString<>'' then
     begin
        ActivaDM1ConsultaSQL('SELECT a.VALOR FROM CATALOGO15SUNAT a WHERE a.CODIGO="'+DM1.ZRegVen.Fields[i].AsString+'";',false);
        cpe.Note.Add;
        cpe.Note.Items[cpe.Note.Count-1].Text:=DM1.ConsultaSQL.Fields[0].AsString;
        cpe.Note.Items[cpe.Note.Count-1].SetAttributeNS('languageLocaleID','',DM1.ZRegVen.Fields[i].AsString);
     end;
  DM1.ConsultaSQL.Close;
  if ENVIAR_GLOSA_A_SUNAT='SI' then
   begin
     cpe.Note.Add;
     cpe.Note.Items[cpe.Note.Count-1].Text:=DM1.ZRegVen.Fields[41].AsString;
   end;


  cpe.DocumentCurrencyCode.Text:=MONEDA;

  // RCPs del documento
  cpe.DiscrepancyResponse.Add;
    cpe.DiscrepancyResponse.Items[0].ReferenceID.Text:=DM1.ZRegVen.Fields[25].AsString+'-'+CompletarCadena(DM1.ZRegVen.Fields[26].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // RCP serie - numero
    cpe.DiscrepancyResponse.Items[0].ResponseCode.Text:=DM1.ZRegVen.Fields[27].AsString;
    cpe.DiscrepancyResponse.Items[0].Description.Add;
      cpe.DiscrepancyResponse.Items[0].Description.Items[0].Text:=DM1.ZRegVen.Fields[28].AsString;

  // Tipo de documento al que se apunta
  cpe.BillingReference.Add;
    cpe.BillingReference.Items[0].InvoiceDocumentReference.ID.Text:=DM1.ZRegVen.Fields[25].AsString+'-'+CompletarCadena(DM1.ZRegVen.Fields[26].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // RCP serie - numero
    cpe.BillingReference.Items[0].InvoiceDocumentReference.DocumentTypeCode.Text:=CompletarCadena(DM1.ZRegVen.Fields[24].AsString,'0',2);

  if (DM1.ZRegVen.Fields[20].AsString)<>'' then  // si hay guias de remision
   begin
    cpe.DespatchDocumentReference.Add;
    cpe.DespatchDocumentReference.Items[0].ID.Text:=DM1.ZRegVen.Fields[20].AsString;
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.Text:=completar2(DM1.ZRegVen.Fields[21].AsString);
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listName','','Tipo de Documento');
    cpe.DespatchDocumentReference.Items[0].DocumentTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo01');

   end;

  // si hubiera mas documentos relacionados, liquidaciones, etc
  //cpe.AdditionalDocumentReference.Add;

  cpe.Signature.Add;
     cpe.Signature.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].Note.Add;
     cpe.Signature.Items[0].Note.Items[0].Text:='EcorsaSoft';
     cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Add;
       cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].SignatoryParty.PartyName.Add;
       if not concdata then
         cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.Text:=eliminaProhibidos(RAZON_EMPRESA)
       else
         cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.ChildNodes.add(NodoRazonEmpresa1);
     cpe.Signature.Items[0].DigitalSignatureAttachment.ExternalReference.URI.Text:=RUC_EMPRESA;

   cpe.AccountingSupplierParty.Party.PartyIdentification.Add;
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeID','','6');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeName','','Documento de Identidad');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
     cpe.AccountingSupplierParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06');
   cpe.AccountingSupplierParty.Party.PartyName.Add;
     if not concdata then
       cpe.AccountingSupplierParty.Party.PartyName.Items[0].Name.Text:=eliminaProhibidos(RAZON_EMPRESA)
     else
       cpe.AccountingSupplierParty.Party.PartyName.Items[0].Name.ChildNodes.add(NodoRazonEmpresa2);
   cpe.AccountingSupplierParty.Party.PartyLegalEntity.Add;
     if not concdata then
       cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=eliminaProhibidos(RAZON_EMPRESA)
     else
       cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoRazonEmpresa3);
     cpe.AccountingSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationAddress.AddressTypeCode.Text:=CODIGO_LOCAL_ANEXO;  // CODIGO_LOCAL_ANEXO

   cpe.AccountingCustomerParty.Party.PartyIdentification.Add;
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.Text:=NRO_DOC_CLIENTE;
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeID','',TIPO_DOC_CLIENTE);
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeName','','Documento de Identidad');
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
     cpe.AccountingCustomerParty.Party.PartyIdentification.Items[0].ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06');
   cpe.AccountingCustomerParty.Party.PartyLegalEntity.Add;
     if not concdata then
       cpe.AccountingCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=eliminaProhibidos(RAZON_NOMBRE_CLIENTE)
     else
       cpe.AccountingCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoNombreCliente);


   // INFORMACION DE DSCTOS GLOBALES
   if ValI(DSCTO_GLOBAL)<>0 then
    begin
      cpe.AllowanceCharge.Add;
       cpe.AllowanceCharge.Items[0].ChargeIndicator.Text:='false';           // catalogo 53
       cpe.AllowanceCharge.Items[0].AllowanceChargeReasonCode.Text:='00';    // cat 53
       //cpe.AllowanceCharge.Items[0].MultiplierFactorNumeric.Text:=DM1.ZRegVen.Fields[32].AsString;
       cpe.AllowanceCharge.Items[0].Amount.Text:= DSCTO_GLOBAL;
         cpe.AllowanceCharge.Items[0].Amount.SetAttributeNS('currencyID','',MONEDA);
       cpe.AllowanceCharge.Items[0].BaseAmount.Text:= StrR(Valr(TOTAL_BRUTO) + Valr(DSCTO_GLOBAL));
         cpe.AllowanceCharge.Items[0].BaseAmount.SetAttributeNS('currencyID','',MONEDA);
    end;


   // INFORMACION DE IMPUESTOS
    cpe.TaxTotal.Add;
      cpe.TaxTotal.Items[0].TaxAmount.Text:=TOTAL_IMPUESTOS;
      cpe.TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

      i:=-1;
      if ValR(importe1001_BIM)<>0 then  // VENTAS GRAVADAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1001_BIM;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=TOTAL_IGV;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='S';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='1000';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='IGV';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
        end;

      if ValR(importe1002_INA)<>0 then  // VENTAS INAFECTAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1002_INA;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=TOTAL_IGV;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='O';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9998';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='INA';        //nombre tributo
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE'; // codigo internacional
        end;

      if ValR(importe1003_EXO)<>0 then  // VENTAS EXONERADAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1003_EXO;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:='0.00';
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='E';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9997';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='EXO';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
        end;


      if ValR(importe1004_GRA)<>0 then  // VENTAS GRATUITAS
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=importe1004_GRA;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:='0.00';
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='O';

            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='9996';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='GRA';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
        end;


      if ValR(OTROS_TRIBUTOS)<>0 then  // IMPUESTO A LAS BOLSAS 31/12  ICBPER Linea 802   20/01
        begin
          cpe.TaxTotal.Items[0].TaxSubtotal.Add; Inc(i);
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.Text:=OTROS_TRIBUTOS;
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.Text:=OTROS_TRIBUTOS;
              cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.Text:='S';

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='18';
            //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:='10';
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
              //cpe.TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.Text:='7152';
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.Name.Text:='ICBPER';        //nombre tributo
            cpe.TaxTotal.Items[0].TaxSubtotal.Items[i].TaxCategory.TaxScheme.TaxTypeCode.Text:='OTH'; // codigo internacional
        end;

    //INFORMACION DE TOTALES
    // es lo que seria la linea pero incluido los dsctos
    cpe.RequestedMonetaryTotal.LineExtensionAmount.Text:=StrR(Valr(TOTAL_BRUTO) + Valr(DSCTO_GLOBAL));
    cpe.RequestedMonetaryTotal.LineExtensionAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.RequestedMonetaryTotal.TaxInclusiveAmount.Text:=IMPORTE_TOTAL;
    cpe.RequestedMonetaryTotal.TaxInclusiveAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.RequestedMonetaryTotal.AllowanceTotalAmount.Text:=DSCTO_GLOBAL;
    cpe.RequestedMonetaryTotal.AllowanceTotalAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.RequestedMonetaryTotal.ChargeTotalAmount.Text:='0.00';
    cpe.RequestedMonetaryTotal.ChargeTotalAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.RequestedMonetaryTotal.PrepaidAmount.Text:='0.00';
    cpe.RequestedMonetaryTotal.PrepaidAmount.SetAttributeNS('currencyID','',MONEDA);

    cpe.RequestedMonetaryTotal.PayableAmount.Text:=IMPORTE_TOTAL;
    cpe.RequestedMonetaryTotal.PayableAmount.SetAttributeNS('currencyID','',MONEDA);


    //ITEMS DE PRODUCTOS
    DM1.ZDetVen.First;
    for i := 0 to DM1.ZDetVen.RecordCount-1 do
     begin
      if i>0 then DM1.ZDetVen.Next;

      cpe.DebitNoteLine.Add;
        cpe.DebitNoteLine.Items[i].ID.Text:=StrI(i+1);
        cpe.DebitNoteLine.Items[i].DebitedQuantity.Text:=StrR2(ValR(DM1.ZDetVen.fields[1].AsString),16,CEROS_XML_CANTIDAD);
          cpe.DebitNoteLine.Items[i].DebitedQuantity.SetAttributeNS('unitCode','',DM1.ZDetVen.fields[2].AsString);
          cpe.DebitNoteLine.Items[i].DebitedQuantity.SetAttributeNS('unitCodeListID','','UN/ECE rec 20');
          cpe.DebitNoteLine.Items[i].DebitedQuantity.SetAttributeNS('unitCodeListAgencyName','','United Nations Economic Commission for Europe');

        //SUBTOTAL O VALOR DE VENTA
        cpe.DebitNoteLine.Items[i].LineExtensionAmount.Text:=StrR2(ValR(DM1.ZDetVen.fields[9].AsString),12,CEROS_XML);
          cpe.DebitNoteLine.Items[i].LineExtensionAmount.SetAttributeNS('currencyID','',MONEDA);

        //PRECIOS DE REFERENCIA
        cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Add;
          cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceAmount.Text:=StrR2(ValR(DM1.ZDetVen.fields[4].AsString),12,CEROS_PRECIOS);
            cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceAmount.SetAttributeNS('currencyID','',MONEDA);
            if DM1.ZDetVen.fields[12].AsString<>'1004' then
              cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.Text:='01'
            else
              cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.Text:='02';
            cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listName','','Tipo de Precio');
            cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
            cpe.DebitNoteLine.Items[i].PricingReference.AlternativeConditionPrice.Items[0].PriceTypeCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo16');

        // INFORMACION DE DESCUENTOS
        if (ValI(DM1.ZDetVen.Fields[7].AsString)<>0) and (False) then
          begin
            cpe.DebitNoteLine.Items[i].AllowanceCharge.Add;
             cpe.DebitNoteLine.Items[i].AllowanceCharge.Items[0].ChargeIndicator.Text:='false';           // catalogo 53
             cpe.DebitNoteLine.Items[i].AllowanceCharge.Items[0].AllowanceChargeReasonCode.Text:='00';    // cat 53
             //cpe.DebitNoteLine.Items[i].AllowanceCharge.Items[0].MultiplierFactorNumeric.Text:=DM1.ZDetVen.Fields[19].AsString;
             cpe.DebitNoteLine.Items[i].AllowanceCharge.Items[0].Amount.Text:= StrR2( ValR(DM1.ZDetVen.Fields[7].AsString),12,CEROS_XML);
             cpe.DebitNoteLine.Items[i].AllowanceCharge.Items[0].Amount.SetAttributeNS('currencyID','',MONEDA);
             cpe.DebitNoteLine.Items[i].AllowanceCharge.Items[0].BaseAmount.Text:= StrR2( ValR(DM1.ZDetVen.Fields[1].AsString)*ValR(DM1.ZDetVen.Fields[6].AsString),12,CEROS_XML);
             cpe.DebitNoteLine.Items[i].AllowanceCharge.Items[0].BaseAmount.SetAttributeNS('currencyID','',MONEDA);
          end;

        //IMPUESTOS POR ITEM XD
        if DM1.ZDetVen.Fields[12].AsString='1001' then //GRAVADAS
         begin
          cpe.DebitNoteLine.Items[i].TaxTotal.Add;
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[11].AsString)+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML);
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[11].AsString),12,CEROS_XML);
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='S';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='1000';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='IGV';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
         end;

        if DM1.ZDetVen.Fields[12].AsString='1002'  then //INAFECTAS
         begin
          cpe.DebitNoteLine.Items[i].TaxTotal.Add;
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR('0.00')+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); // ina + icbper
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='O';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9998';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='INA';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
         end;

        if (DM1.ZDetVen.Fields[12].AsString='1003')  then //EXONERADAS
         begin
          cpe.DebitNoteLine.Items[i].TaxTotal.Add;
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR('0.00')+ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); // exo + icbper
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='E';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:='0.00';  //R02-03-2019 StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9997';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='EXO';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='VAT';
         end;

        if (DM1.ZDetVen.Fields[12].AsString='1004') then //GRATUITAS
         begin
          cpe.DebitNoteLine.Items[i].TaxTotal.Add;
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:='0.00';
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.Text:='0.00';
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='O';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeID','','UN/ECE 5305');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.Percent.Text:=StrR2( ValR(DM1.ZRegVen.Fields[33].AsString)*100,12,CEROS_XML);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.Text:='9996';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeID','','UN/ECE 5153');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.Name.Text:='GRA';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxScheme.TaxTypeCode.Text:='FRE';
         end;

        if (ValR(OTROS_TRIBUTOS)<>0) and (ValR(DM1.ZDetVen.Fields[22].AsString)>0) then //ICBPER 21-12-2019 item Line Linea 1002 22/01/20
         begin
          //cpe.InvoiceLine.Items[i].TaxTotal.Add;
            //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.Text:=StrR2( ValR(OTROS_TRIBUTOS),12,CEROS_XML);
            //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

            cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Add;
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[9].AsString),12,CEROS_XML);
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxableAmount.SetAttributeNS('currencyID','',MONEDA);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[22].AsString),12,CEROS_XML); //Impuesto
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxAmount.SetAttributeNS('currencyID','',MONEDA);

              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].BaseUnitMeasure.Text:=StrR2( ValR(DM1.ZDetVen.Fields[20].AsString),12,0);   // bolsas cantidad
                cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].BaseUnitMeasure.SetAttributeNS('unitCode','',DM1.ZDetVen.Fields[2].AsString);

              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.ID.Text:='S';
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeName','','Tax Category Identifier');
              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.Percent.Text:=StrR2( 0.00,12,CEROS_XML);
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.PerUnitAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[20].AsString),12,CEROS_XML);  // tasa icbper
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.PerUnitAmount.SetAttributeNS('currencyID','',MONEDA);

              //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.Text:=DM1.ZDetVen.Fields[13].AsString;
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listName','','Afectacion del IGV');
                //cpe.InvoiceLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[0].TaxCategory.TaxExemptionReasonCode.SetAttributeNS('listURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.Text:='7152';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeURI','','urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeName','','Codigo de tributos');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.ID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.Name.Text:='ICBPER';
              cpe.DebitNoteLine.Items[i].TaxTotal.Items[0].TaxSubtotal.Items[1].TaxCategory.TaxScheme.TaxTypeCode.Text:='OTH';
         end;


        //DETALLES DEL ITEM
        cpe.DebitNoteLine.Items[i].Item.Description.Add;
        cpe.DebitNoteLine.Items[i].Item.Description.Items[0].Text:=eliminaprohibidos(DM1.ZDetVen.Fields[3].AsString);
        cpe.DebitNoteLine.Items[i].Item.SellersItemIdentification.ID.Text:=DM1.ZDetVen.Fields[16].AsString;
        if  DM1.ZDetVen.Fields[17].AsString<>'' then
          begin
            cpe.DebitNoteLine.Items[i].Item.CommodityClassification.Add;
            cpe.DebitNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.Text:=DM1.ZDetVen.Fields[17].AsString;
            //4252 cpe.DebitNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listID','','UNSPSC');
            //4252 cpe.DebitNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listAgencyName','','GS1 US');
            //4252 cpe.DebitNoteLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listName','','Classification');
          end;
        if Trim(DM1.ZRegVen.Fields[22].AsString)<>'' then  // SI HAY PLACA
          begin
            cpe.DebitNoteLine.Items[i].Item.AdditionalItemProperty.Add;
            cpe.DebitNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].Name.Text:=DM1.ZRegVen.Fields[22].AsString;
            {cpe.DebitNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].Name.Text:='Gastos Art. 37 Renta: Numero de Placa';
            cpe.DebitNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.Text:='7000';
              cpe.DebitNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.SetAttributeNS('listName','','Propiedad del item');
              cpe.DebitNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].NameCode.SetAttributeNS('listAgencyName','','PE:SUNAT');
            cpe.DebitNoteLine.Items[i].Item.AdditionalItemProperty.Items[0].Value.Text:=DM1.ZRegVen.Fields[22].AsString;}
          end;

        //PRECIO DE VENTA
        if (DM1.ZDetVen.Fields[12].AsString='1004') then
          cpe.DebitNoteLine.Items[i].Price.PriceAmount.Text:='0.0000'
        else
          cpe.DebitNoteLine.Items[i].Price.PriceAmount.Text:=StrR2( ValR(DM1.ZDetVen.Fields[6].AsString),12,CEROS_PRECIOS);  // desagregado
        cpe.DebitNoteLine.Items[i].Price.PriceAmount.SetAttributeNS('currencyID','',MONEDA);
     end;


  xmldoc.XML.Text := FormatXMLData(cpe.XML);
  xmldoc.Active := true;
  xmldoc.Encoding :=codificadoXML;
  xmldoc.StandAlone:='no';
    xmldoc.SaveToFile(archivo);
  xmldoc.Active := false;
   if concdata then
     begin
       hoja.Lines.LoadFromFile(archivo);
       for i := 0  to hoja.Lines.Count-1 do
         begin
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'-=|','<');
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'|=-','>');
         end;
       hoja.Lines.SaveToFile(archivo);
       hoja.Clear;
     end;
   Result:=0;
 end;


function TFrmGenCPE.ComunicacionBaja(dual : string; archivo : string; concdata : Boolean):Integer;
 begin
   Result:=0;
 end;


function TFrmGenCPE.GeneraDespachtAdvice(dual : string; archivo : string; concdata : Boolean):Integer;
var cpe : IXMLDespatchAdviceType;
    i : Integer;

    TIPO_DOC_CLIENTE, NRO_DOC_CLIENTE,RAZON_NOMBRE_CLIENTE : string;

    NodoRazonEmpresa1  : IXMLNode;
    NodoRazonEmpresa2  : IXMLNode;
    NodoRazonEmpresa3  : IXMLNode;
    NodoNombreCliente : IXMLNode;

 begin
  {
  REGISTROVENTAS
  //               0            1            2           3            4           5           6              7               8
  'select a.'+IDDUAL+',a.FECHAEMISION,a.HORA,a.TIPOCOMPROBANTE,a.SERIECO,a.NUMEROCO,a.TIPODOCUMENTO,a.NRODOCUMENTO,a.RAZONNOMBRE, '+
  //  9                   10                              11                             12
  'a.MONEDA,abs(a.BASEIMPONIBLE) AS BASEIMPONIBLE,abs(a.INAFECTAS) AS INAFECTAS,abs(a.TOTALEXONERADA) AS TOTALEXONERADA,'+
  //              13                    14                       15                      16
  'abs(a.GRATUITAS) AS GRATUITAS,abs(a.IGVIPM) AS IGVIPM,abs(a.ISC) AS ISC,abs(a.OTROSTRIBUTOS) AS OTROSTRIBUTOS,'+
  //            17                          18                             19                        20            21
  'abs(a.DESCUENTOS) AS DESCUENTOS,abs(a.CARGOS) AS CARGOS, abs(a.IMPORTETOTAL) AS IMPORTETOTAL,a.GUIAREMISION,a.TIPOGUIA,'+
  //   22                 23                   24         25          26          27          28           29             30
  ' a.PLACA,abs(a.PERCEPCION) AS PERCEPCION,a.RCPTIPO,a.RCPSERIE,a.RCPNUMERO,a.CODIGONOTA,a.MOTIVONOTA,a.TIPOPAGO,a.FECHAVENCIMIENTO '+
        31         32        33         34            35               36            37           38             39           40        41
    TIPODSCTO, DSCTOUNIT, IGVTASA, a.ENVIOSUNAT, a.DSCTOGLOBAL, a.CARGOGLOBAL, a.CAT15_ELEM1,a.CAT15_ELEM2,a.CAT15_ELEM3,a.CAT15_ELEM4,GLOSA

   LINEACOMPROBANTE
   //       0            1         2           3          4      5         6        7        8
   'SELECT a.ITEM, a.CANTIDAD, Unidad, a.DESCRIPCION, a.PU, a.PU_OR, a.VVUNIT,  a.DSCTO, a.CARGO, '+
   //   9       10     11          12                13          14         15          16           17
   'a.VVITEM, a.ISC, a.IGV, a.TIPOOPERACION, a.TIPOAFECTACION, a.MONTO, a.SUBTOTAL, a.PRODUCTO, a.CodigoSUNAT,
   //   18             19        20          21           22    23
   'a.TIPODSCTO, a.DSCTOUNIT, a.BOLSAS, a.TASAICBPER, a.ICBPER, a.PESO'+

   GUIAREMISION
   //         0            1              2             3                 4               5                      6
   SELECT a.SERIEDOC, a.NUMERODOC, a.FECHAEMISION, a.FECHATRASLADO, a.PUNTOPARTIDA, a.PUNTOLLEGADA, a.RAZONSOCIALDESTINATARIO,
   // 7       8         9          10                   11                   12                   13               14
   a.RUC, a.PLACA, a.MARCA, a.CERTINSCRIPCION, a.LICENCIACONDUCIR, a.RAZONSOCIALTRANSPORTE, a.TIPODOCPAGO, a.NROCOMPROBANTEPAGO,
   //      15               16             17          18           19                  20                 21              22
   a.MOTIVOTRASLADO, a.RUCTRANSPORTE, a.TIPOGUIA, a.PESOTOTAL, a.DOCREFERENCIA,a.TIPODOCREFERENCIA,a.CONREFERENCIA,a.CODIGOTRASLADO
   //      23                 24                 25                26            27           28               29
   a.TRASBORDOPROGRAMADO, a.UNIDADPESO, a.TOTALPAQUETES, a.TRANSPORTMODECODE, a.DNIS, a.UBIGEOORIGEN, a.UBIGEODESTINO

   FROM GUIAREMISION a
   }


  if concdata then
   begin
     XMLdoc.active:=True;
     NodoRazonEmpresa1 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
     NodoRazonEmpresa2 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
     NodoRazonEmpresa3 :=XMLDoc.CreateNode (RAZON_EMPRESA, ntCDATA);
     NodoNombreCliente :=XMLDoc.CreateNode (RAZON_NOMBRE_CLIENTE, ntCDATA);
   end;

  btnLevantarGuiaRemClick(nil);          // GUIA REMISION
  BtnLevantarDetallesVentaClick(NIL);    // LINEA COMPROBANTE

  if Length(DM1.ZGuiaRem.Fields[7].AsString)=11 then  TIPO_DOC_CLIENTE:='6'
  ELSE TIPO_DOC_CLIENTE:='1';
  NRO_DOC_CLIENTE:=DM1.ZGuiaRem.Fields[7].AsString;
  RAZON_NOMBRE_CLIENTE:=DM1.ZGuiaRem.Fields[6].AsString;

  cpe:=NewDespatchAdvice;

  cpe.UBLExtensions.Add;
  cpe.UBLExtensions.UBLExtension[0].AddChild('ext:ExtensionContent');

  cpe.UBLVersionID.Text:='2.1';
  cpe.CustomizationID.Text:='1.0';
  cpe.CustomizationID.SetAttributeNS('schemeAgencyName','','PE:SUNAT');

  cpe.ID.Text:=DM1.zGuiaRem.Fields[0].AsString+'-'+CompletarCadena(DM1.ZGuiaRem.Fields[1].AsString,'0',DIGITOS_NUMCOMPROBANTE);            // serie - numero
  cpe.IssueDate.Text:=Copy(DM1.ZGuiaRem.Fields[2].AsString,7,4)+'-'+
                      Copy(DM1.ZGuiaRem.Fields[2].AsString,4,2)+'-'+
                      Copy(DM1.ZGuiaRem.Fields[2].AsString,1,2);                   // fecha de emision

  //cpe.IssueTime.Text:=totime24(DM1.ZRegVen.Fields[2].AsString);                  // hora de emision
  cpe.DespatchAdviceTypeCode.Text:=Comp2(DM1.ZGuiaRem.Fields[17].AsString);        // codigo de tipo documento Catalogo 01
  //cpe.Note.Add;
    //cpe.Note.Items[0].Text:='<![CDATA[ ]]>';       // observaciones, ejemplo transporte bolsa de basura

  {cpe.OrderReference.Add;
     cpe.OrderReference.Items[0].ID:='T001-8';
     cpe.OrderReference.Items[0].OrderTypeCode.Text:='09';
     cpe.OrderReference.Items[0].OrderTypeCode.SetAttributeNS('name','','Guia de Remision');}   // Para guia Remision dado de Baja

  if DM1.ZGuiaRem.Fields[21].AsString = '1' then                                                // si tiene docreferencia
   begin
    cpe.AdditionalDocumentReference.Add;
      cpe.AdditionalDocumentReference.Items[0].ID.Text:=DM1.ZGuiaRem.Fields[19].AsString;
      cpe.AdditionalDocumentReference.Items[0].DocumentTypeCode.Text:=completar2(DM1.ZGuiaRem.Fields[20].AsString);
   end;

  cpe.Signature.Add;                                                                             // Firma del Sw y Firma Empresa
     cpe.Signature.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].Note.Add;
     cpe.Signature.Items[0].Note.Items[0].Text:='EcorsaSoft';
     cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Add;
       cpe.Signature.Items[0].SignatoryParty.PartyIdentification.Items[0].ID.Text:=RUC_EMPRESA;
     cpe.Signature.Items[0].SignatoryParty.PartyName.Add;
       if not concdata then
          cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.text:=EliminaProhibidos(RAZON_EMPRESA)
       else
          cpe.Signature.Items[0].SignatoryParty.PartyName.Items[0].Name.ChildNodes.add(NodoRazonEmpresa1);
     cpe.Signature.Items[0].DigitalSignatureAttachment.ExternalReference.URI.Text:=RUC_EMPRESA;

   //INFORMACION DEL EMISOR
   cpe.DespatchSupplierParty.CustomerAssignedAccountID.Text:=RUC_EMPRESA;
   cpe.DespatchSupplierParty.CustomerAssignedAccountID.SetAttributeNS('schemeID','','6');
   cpe.DespatchSupplierParty.Party.PartyLegalEntity.Add;
     if not concdata then
       cpe.DespatchSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=EliminaProhibidos(RAZON_EMPRESA)
     else
       cpe.DespatchSupplierParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoRazonEmpresa2);

   //INFORMACION DEL CLIENTE, pueden ser varios, terceros
   cpe.DeliveryCustomerParty.CustomerAssignedAccountID.Text:=NRO_DOC_CLIENTE;
   cpe.DeliveryCustomerParty.CustomerAssignedAccountID.SetAttributeNS('schemeID','',TIPO_DOC_CLIENTE);
    Begin
     cpe.DeliveryCustomerParty.Party.PartyLegalEntity.Add;
       if not concdata then
          cpe.DeliveryCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.Text:=EliminaProhibidos(RAZON_NOMBRE_CLIENTE)
       else
          cpe.DeliveryCustomerParty.Party.PartyLegalEntity.Items[0].RegistrationName.ChildNodes.add(NodoNombreCliente);
    End;

    //DATOS DEL ENVIO
    cpe.Shipment.ID.Text:='1';
      cpe.Shipment.HandlingCode.Text:=completar2(DM1.ZGuiaRem.Fields[22].AsString);    //catalogo 20 codigo
      cpe.Shipment.Information.Add;
      cpe.Shipment.Information.Items[0].Text:=DM1.ZGuiaRem.Fields[15].AsString;  //catalogo 20 descripcion

      cpe.Shipment.GrossWeightMeasure.Text:=StrR2(ValR(DM1.ZGuiaRem.Fields[18].AsString),16,CEROS_XML);
        cpe.Shipment.GrossWeightMeasure.SetAttributeNS('unitCode','',DM1.ZGuiaRem.Fields[24].AsString);
      cpe.Shipment.SplitConsignmentIndicator.Text:=StrToBooleanStr(DM1.ZGuiaRem.Fields[23].AsString);  // ind. trasbordo prog true/false
      //cpe.Shipment.TotalTransportHandlingUnitQuantity.Text:=DM1.ZGuiaRem.Fields[25].AsString;        // no se puede parsear

      cpe.Shipment.ShipmentStage.Add;
        cpe.Shipment.ShipmentStage.Items[0].TransportModeCode.Text:=DM1.ZGuiaRem.Fields[26].AsString;  // cat 18 mod trasl 01 publico, 02 privado
        cpe.Shipment.ShipmentStage.Items[0].TransitPeriod.StartDate.Text:=Copy(DM1.ZGuiaRem.Fields[3].AsString,7,4)+'-'+
                                                                          Copy(DM1.ZGuiaRem.Fields[3].AsString,4,2)+'-'+
                                                                          Copy(DM1.ZGuiaRem.Fields[3].AsString,1,2); // fecha de inicio traslado

      if DM1.ZGuiaRem.Fields[26].AsString='01' then // transporte publico
        begin
          //datos del transportista RUC,RAZON SOCIAL
          cpe.Shipment.ShipmentStage.Items[0].CarrierParty.Add;
            cpe.Shipment.ShipmentStage.Items[0].CarrierParty.Items[0].PartyIdentification.Add;
              cpe.Shipment.ShipmentStage.Items[0].CarrierParty.Items[0].PartyIdentification.Items[0].Text:= DM1.ZGuiaRem.Fields[16].AsString;

            cpe.Shipment.ShipmentStage.Items[0].CarrierParty.Items[0].PartyName.Add;
            if not concdata then
              cpe.Shipment.ShipmentStage.Items[0].CarrierParty.Items[0].PartyName.Items[0].Text:=EliminaProhibidos(DM1.ZGuiaRem.Fields[12].AsString)
            else
              cpe.Shipment.ShipmentStage.Items[0].CarrierParty.Items[0].PartyName.Items[0].Text:=DM1.ZGuiaRem.Fields[12].AsString;
        end
       else
        begin
          //datos del transportista placa principal
          cpe.Shipment.ShipmentStage.Items[0].TransportMeans.RoadTransport.LicensePlateID.Text:=Trim(SplitCadena(DM1.ZGuiaRem.Fields[8].AsString,'/',1));
          i:=1;
          // DNIs del chofer
          while Trim(SplitCadena(DM1.ZGuiaRem.Fields[27].AsString,'/',i))<>'' do
           begin
            cpe.Shipment.ShipmentStage.Items[0].DriverPerson.Add;
               cpe.Shipment.ShipmentStage.Items[0].DriverPerson.Items[i-1].ID.Text:=Trim(SplitCadena(DM1.ZGuiaRem.Fields[27].AsString,'/',i));
               cpe.Shipment.ShipmentStage.Items[0].DriverPerson.Items[i-1].ID.SetAttributeNS('schemeID','','1');
            inc(i);
           end;
        end;

      //punto de llegada
      cpe.Shipment.Delivery.DeliveryAddress.ID.Text:=DM1.ZGuiaRem.Fields[29].AsString;
      if not concdata then
        cpe.Shipment.Delivery.DeliveryAddress.StreetName.Text:=EliminaProhibidos(DM1.ZGuiaRem.Fields[5].AsString)
      else
        cpe.Shipment.Delivery.DeliveryAddress.StreetName.Text:=DM1.ZGuiaRem.Fields[5].AsString;

      // varias placas
      if Trim(SplitCadena(DM1.ZGuiaRem.Fields[8].AsString,'/',2))<>'' then
       begin
         cpe.Shipment.TransportHandlingUnit.Add;
         cpe.Shipment.TransportHandlingUnit.Items[0].ID.Text:=Trim(SplitCadena(DM1.ZGuiaRem.Fields[8].AsString,'/',1));
         i:=2;
         while Trim(SplitCadena(DM1.ZGuiaRem.Fields[8].AsString,'/',i))<>'' do
          begin
            cpe.Shipment.TransportHandlingUnit.Items[0].TransportEquipment.Add;
            cpe.Shipment.TransportHandlingUnit.Items[0].TransportEquipment.Items[i-2].ID.Text:=Trim(SplitCadena(DM1.ZGuiaRem.Fields[8].AsString,'/',i));
            Inc(i);
          end;
       end;

      // DATOS DEL CONTENEDOR
      // TransportEquipement = 120606

      //punto de origen
      cpe.Shipment.OriginAddress.ID.Text:=DM1.ZGuiaRem.Fields[28].AsString;
      if not concdata then
        cpe.Shipment.OriginAddress.StreetName.Text:=EliminaProhibidos(DM1.ZGuiaRem.Fields[4].AsString)
      else
        cpe.Shipment.OriginAddress.StreetName.Text:=DM1.ZGuiaRem.Fields[4].AsString;

      // AREOPUERTO EN CASO de envios aereopuerto
      // FirstArrivalPortLocation = PAI

    //ITEMS DE PRODUCTOS
    DM1.ZDetVen.First;
    for i := 0 to DM1.ZDetVen.RecordCount-1 do
     begin
      if i>0 then DM1.ZDetVen.Next;

      cpe.DespatchLine.Add;
        cpe.DespatchLine.Items[i].ID.Text:=StrI(i+1);
        cpe.DespatchLine.Items[i].DeliveredQuantity.Text:=StrR2(ValR(DM1.ZDetVen.fields[1].AsString),16,CEROS_XML_CANTIDAD);
           cpe.DespatchLine.Items[i].DeliveredQuantity.SetAttributeNS('unitCode','',DM1.ZDetVen.fields[2].AsString);

        cpe.DespatchLine.Items[i].OrderLineReference.Add;
           cpe.DespatchLine.Items[i].OrderLineReference.Items[0].LineID.Text:=StrI(i+1);

        cpe.DespatchLine.Items[i].Item.Name.Text:=eliminaProhibidos(DM1.ZDetVen.Fields[3].AsString);
        cpe.DespatchLine.Items[i].Item.SellersItemIdentification.ID.Text:=DM1.ZDetVen.Fields[16].AsString;
        if Trim(DM1.ZDetVen.Fields[17].AsString)<>'' then    // si hay codigo SUNAT
          begin
            cpe.DespatchLine.Items[i].Item.CommodityClassification.Add;
            cpe.DespatchLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.Text:=DM1.ZDetVen.Fields[17].AsString;
            //4252 cpe.InvoiceLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listID','','UNSPSC');
            //4252 cpe.InvoiceLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listAgencyName','','GS1 US');
            //4252 cpe.InvoiceLine.Items[i].Item.CommodityClassification.Items[0].ItemClassificationCode.SetAttributeNS('listName','','Classification');
          end;

     end;

  xmldoc.XML.Text := FormatXMLData(cpe.XML);
  xmldoc.Active := true;
  xmldoc.Encoding :=codificadoXML;
  xmldoc.StandAlone:='no';
    //ShowMessage(archivo);
    xmldoc.SaveToFile(archivo);
  xmldoc.Active := false;
   if concdata then
     begin
       hoja.Lines.LoadFromFile(archivo);
       for i := 0  to hoja.Lines.Count-1 do
         begin
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'-=|','<');
           hoja.Lines[i]:=StrCom(hoja.Lines[i],'|=-','>');
         end;
       hoja.Lines.SaveToFile(archivo);
       hoja.Clear;
     end;
   Result:=0;
 end;


function TFrmGenCPE.GeneraSummaryDocs(dual : string; archivo : string; concdata : Boolean; limiteI,LimiteS,indice : integer):Integer;
 begin
   Result:=0;
 end;


function TFrmGenCPE.CPEenvioBETA(pathenvio,archivo,ticket:string):Boolean;
{BETA}
begin

end;

procedure TFrmGenCPE.btnLevantarGuiaRemClick(Sender: TObject);
begin
  DM1.ZGuiaRem.Close;
  DM1.ZGuiaRem.SQL.Clear;
  DM1.ZGuiaRem.SQL.Add(FormatSQL3(
   //         0            1              2             3                 4               5                      6
   'SELECT a.SERIEDOC, a.NUMERODOC, a.FECHAEMISION, a.FECHATRASLADO, a.PUNTOPARTIDA, a.PUNTOLLEGADA, a.RAZONSOCIALDESTINATARIO, '+
   // 7       8         9          10                   11                   12                   13               14
   'a.RUC, a.PLACA, a.MARCA, a.CERTINSCRIPCION, a.LICENCIACONDUCIR, a.RAZONSOCIALTRANSPORTE, a.TIPODOCPAGO, a.NROCOMPROBANTEPAGO, '+
   //      15               16             17          18           19                 20                  21              22
   'a.MOTIVOTRASLADO, a.RUCTRANSPORTE, a.TIPOGUIA, a.PESOTOTAL, a.DOCREFERENCIA,a.TIPODOCREFERENCIA,a.CONREFERENCIA,a.CODIGOTRASLADO, '+
   //      23                 24                 25                26            27           28               29
   'a.TRASBORDOPROGRAMADO, a.UNIDADPESO, a.TOTALPAQUETES, a.TRANSPORTMODECODE, a.DNIS, a.UBIGEOORIGEN, a.UBIGEODESTINO '+
   'FROM GUIAREMISION a '+
  'WHERE  a.dual='+StrI(ValI(DM1.ZRegVen.Fields[0].Asstring))));
  DM1.ZGuiaRem.Open;

  if DM1.ZGuiaRem.RecordCount=0 then
   begin
     MessageDlg('El Comprobante '+DM1.ZRegVen.fields[19].AsString+'-'+CompletarCadena(DM1.ZRegVen.fields[20].AsString,'0',DIGITOS_NUMCOMPROBANTE)+' no tiene guia remision, revise ', mtError,[mbOk], 0);
     Exit;
   end;

end;

end.
